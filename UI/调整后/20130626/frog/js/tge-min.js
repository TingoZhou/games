/* Copyright (c) 2013 TreSensa, Inc. All Rights Reserved. */

var TGE=TGE||{};TGE.log=function(){if(window.console){window.console.log(Array.prototype.slice.call(arguments))}};TGE.debugLog=function(){};function extend(e,b){var a=e.prototype;var d=function(){};d.prototype=b.prototype;e.prototype=new d();e.prototype.constructor=e;e.superclass=b.prototype;if(b.prototype.constructor===Object.prototype.constructor){b.prototype.constructor=b}for(var f in a){if(a.hasOwnProperty(f)){e.prototype[f]=a[f]}}}if(!Function.prototype.bind){Function.prototype.bind=function(a){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var f=Array.prototype.slice.call(arguments,1),e=this,b=function(){},d=function(){return e.apply(this instanceof b&&a?this:a,f.concat(Array.prototype.slice.call(arguments)))};b.prototype=this.prototype;d.prototype=new b();return d}}window.requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1000/60)}})();function getElementPosition(b){var d=b;var e="";var a=0;var f=0;if(d==null){return null}while((typeof(d)=="object")&&(typeof(d.tagName)!="undefined")){f+=d.offsetTop;a+=d.offsetLeft;e=d.tagName.toUpperCase();if(e=="BODY"){d=0}if(typeof(d)=="object"){if(typeof(d.offsetParent)=="object"){d=d.offsetParent}}if(d==null){return null}}return{x:a,y:f}}function getQueryString(){var b={},e=location.search.substring(1),d=/([^&=]+)=([^&]*)/g,a;while(a=d.exec(e)){b[decodeURIComponent(a[1])]=decodeURIComponent(a[2])}return b}function getDistributionPartner(){var a=getQueryString()["dst"];return(typeof a==="string")?a:null}function loadScript(b,e){var d=document.getElementsByTagName("head")[0];var a=document.createElement("script");a.type="text/javascript";a.src=b;a.onreadystatechange=e;a.onload=e;d.appendChild(a)}TGE.BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"an unknown browser";this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version";this.platform=this.searchString(this.dataPlatform)||"an unknown OS or Device";this.OSversion=this.detectOSversion(this.platform);this.isMobileDevice=!(this.platform==="Windows"||this.platform==="Mac"||this.platform==="Linux");this.oniOS=this.platform==="iPhone"||this.platform==="iPad";this.onAndroid=this.platform==="Android";this.usingPhoneGap=(window.PhoneGap||window.cordova||window.Cordova)},detectOSversion:function(b){var f="-1";var e="";var a=navigator.userAgent.toString();switch(b){case"Windows Phone":e=/Windows Phone OS\s+[\d\.]+/;f=String(a.match(e)).substring(17,20);break;case"iPhone":case"iPad":e=/OS\s+[\d\_]+/;f=String(a.match(e)).substring(3,6);break;case"Windows":e=/Windows NT\s+[\d\.]+/;var d=String(a.match(e)).substring(11,14);if(d=="6.1"){f="7"}else{if(d=="5.1"){f="XP"}else{if(d=="5.2"){f="XP"}else{if(d=="6.0"){f="Vista"}else{if(d=="5.01"){f="2000 SP1"}else{if(d=="5.0"){f="2000"}}}}}}break;case"Mac":e=/Mac OS X\s+[\d\_]+/;f=String(a.match(e)).substring(9,13);break;case"Android":e=/ndroid\s+[\d\.]+/;f=String(a.match(e)).substring(7,10);break}return f},searchString:function(e){for(var a=0;a<e.length;a++){if(e[a]!=null){var b=e[a].string;var d=e[a].prop;this.versionSearchString=e[a].versionSearch||e[a].identity;if(b){if(b.indexOf(e[a].subString)!==-1){return e[a].identity}}else{if(d){return e[a].identity}}}}},searchVersion:function(b){var a=b.indexOf(this.versionSearchString);if(a===-1){return}return parseFloat(b.substring(a+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Explorer",identity:"Explorer",versionSearch:"Explorer"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{prop:window.opera,identity:"Opera"},{string:navigator.userAgent,subString:"Silk",identity:"Silk",versionSearch:"Silk"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.vendor,subString:"BlackBerry",identity:"BlackBerry"}],dataPlatform:[{string:navigator.userAgent,subString:"Windows Phone",identity:"Windows Phone"},{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone"},{string:navigator.userAgent,subString:"iPad",identity:"iPad"},{string:navigator.userAgent,subString:"iPod",identity:"iPod"},{string:navigator.userAgent,subString:"Android",identity:"Android"},{string:navigator.userAgent,subString:"Silk",identity:"Kindle Fire"},{string:navigator.userAgent,subString:"webOS",identity:"webOS"},{string:navigator.userAgent,subString:"Mobile",identity:"Mobile"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};TGE.BrowserDetect.init();if(TGE.BrowserDetect.platform==="iPhone"||TGE.BrowserDetect.platform==="iPad"){var _vp=document.querySelector("meta[name=viewport]");if(_vp){_vp.setAttribute("content","maximum-scale=1, minimum-scale=1, initial-scale=1, user-scalable=no")}}TGE.Matrix=function(h,f,k,j,g,e){h=typeof h!=="undefined"?h:1;f=typeof f!=="undefined"?f:0;k=typeof k!=="undefined"?k:0;j=typeof j!=="undefined"?j:1;g=typeof g!=="undefined"?g:0;e=typeof e!=="undefined"?e:0;this._internal=[h,k,g,f,j,e,0,0,1]};TGE.Matrix.RotationMatrix=function(b){var a=new TGE.Matrix();a._internal[0]=Math.cos(b);a._internal[1]=-Math.sin(b);a._internal[3]=Math.sin(b);a._internal[4]=Math.cos(b);return a};TGE.Matrix.ScaleMatrix=function(b,a){return new TGE.Matrix().scale(b,a)};TGE.Matrix.TranslationMatrix=function(b,a){return new TGE.Matrix().translate(b,a)};TGE.Matrix.prototype={_internal:null,identity:function(){var a=this._internal;a[1]=a[2]=a[3]=a[5]=a[6]=a[7]=0;a[0]=a[4]=a[8]=1;return this},copyFrom:function(b){var a=this._internal;var d=b._internal;a[0]=d[0];a[1]=d[1];a[2]=d[2];a[3]=d[3];a[4]=d[4];a[5]=d[5];a[6]=d[6];a[7]=d[7];a[8]=d[8];return this},concat:function(n){var m=this._internal;var l=n._internal;var k=m[0]*l[0]+m[1]*l[3]+m[2]*l[6];var j=m[0]*l[1]+m[1]*l[4]+m[2]*l[7];var h=m[0]*l[2]+m[1]*l[5]+m[2]*l[8];var g=m[3]*l[0]+m[4]*l[3]+m[5]*l[6];var f=m[3]*l[1]+m[4]*l[4]+m[5]*l[7];var e=m[3]*l[2]+m[4]*l[5]+m[5]*l[8];var d=m[6]*l[0]+m[7]*l[3]+m[8]*l[6];var b=m[6]*l[1]+m[7]*l[4]+m[8]*l[7];var a=m[6]*l[2]+m[7]*l[5]+m[8]*l[8];m[0]=k;m[1]=j;m[2]=h;m[3]=g;m[4]=f;m[5]=e;m[6]=d;m[7]=b;m[8]=a;return this},rotate:function(a){return this.concat(TGE.Matrix.RotationMatrix(a*TGE.DEG2RAD))},scale:function(d,b){var a=this._internal;a[0]*=d;a[1]*=b;a[3]*=d;a[4]*=b;return this},translate:function(b,a){this._internal[2]+=b;this._internal[5]+=a;return this},transformPoint:function(b){var a=b.x;var d=b.y;b.x=a*this._internal[0]+d*this._internal[1]+this._internal[2];b.y=a*this._internal[3]+d*this._internal[4]+this._internal[5];return b}};TGE.Point=function(a,b){a=typeof a!=="undefined"?a:0;b=typeof b!=="undefined"?b:0;this.x=a;this.y=b;return this};TGE.Point.prototype={setTo:function(a,b){this.x=a;this.y=b},copyFrom:function(a){this.x=a.x;this.y=a.y;return this},add:function(a){return new this.constructor(this.x+a.x,this.y+a.y)},subtract:function(a){return new this.constructor(this.x-a.x,this.y-a.y)},offset:function(b,a){this.x+=b;this.y+=a;return this},rotate:function(b){var a=b*TGE.DEG2RAD;return new this.constructor(this.x*Math.cos(a)-this.y*Math.sin(a),this.y*Math.cos(a)+this.x*Math.sin(a))},rotateThis:function(e){var d=e*TGE.DEG2RAD;var a=this.x*Math.cos(d)-this.y*Math.sin(d);var b=this.y*Math.cos(d)+this.x*Math.sin(d);this.setTo(a,b);return this}};TGE.Vector2D=function(a,b){TGE.Vector2D.superclass.constructor.call(this,a,b)};TGE.Vector2D.prototype={magnitude:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},dotProduct:function(a){return this.x*a.x+this.y*a.y},crossProduct:function(a){return this.x*a.y-this.y*a.x},angleBetween:function(a){var b=this.magnitude()*a.magnitude();if(b===0){return 0}return Math.acos(this.dotProduct(a)/b)*TGE.RAD2DEG}};extend(TGE.Vector2D,TGE.Point);TGE.Rectangle=function(b,e,d,a){b=typeof b!=="undefined"?b:0;e=typeof e!=="undefined"?e:0;d=typeof d!=="undefined"?d:0;a=typeof a!=="undefined"?a:0;this.x=b;this.y=e;this.width=d;this.height=a};TGE.Rectangle.prototype={intersects:function(j,m,k){m=typeof m==="undefined"?1:m;k=typeof k==="undefined"?1:k;var o=this.width*(1-m)/2;var n=this.height*(1-m)/2;var l=this.x+o;var h=this.y+n;var e=this.x+this.width-o;var d=this.y+this.height-n;o=j.width*(1-k)/2;n=j.height*(1-k)/2;var g=j.x+o;var f=j.y+n;var b=j.x+j.width-o;var a=j.y+j.height-n;if(g>=l&&b<=e&&f>=h&&a<=d){return true}if((e<g||l>b)||(d<f||h>a)){return false}return true},union:function(a){var h=this.x+this.width;var g=this.y+this.height;var d=a.x+a.width;var b=a.y+a.height;this.x=Math.min(this.x,a.x);this.y=Math.min(this.y,a.y);var f=Math.max(h,d);var e=Math.max(g,b);this.width=f-this.x;this.height=e-this.y}};TGE.PI=3.1415926535;TGE.TWO_PI=6.2831853072;TGE.RAD2DEG=57.2957795;TGE.DEG2RAD=0.0174532925;TGE.POSITIVE_X_VECTOR=new TGE.Vector2D(1,0);TGE.NEGATIVE_X_VECTOR=new TGE.Vector2D(-1,0);TGE.POSITIVE_Y_VECTOR=new TGE.Vector2D(0,1);TGE.NEGATIVE_Y_VECTOR=new TGE.Vector2D(0,-1);TGE.DisplayObject=function(){this.x=0;this.y=0;this.scaleX=1;this.scaleY=1;this.rotation=0;this.alpha=1;this.backgroundColor=null;this.visible=true;this.width=0;this.height=0;this.registrationX=0.5;this.registrationY=0.5;this.parent=null;this.stage=null;this.mouseEnabled=false;this.instanceName="";this._mLocalTransform=new TGE.Matrix();this._mLocalTransformNoReg=new TGE.Matrix();this._mWorldTransform=new TGE.Matrix();this._mWorldTransformNoReg=new TGE.Matrix();this._mRegistrationTransform=new TGE.Matrix();this._mTopLeft=new TGE.Point();this._mBottomRight=new TGE.Point();this._mAABB=new TGE.Rectangle();this._boundingInfoDirty=true;return this};TGE.DisplayObject.prototype={_mPreviousX:0,_mPreviousY:0,_mPreviousScaleX:1,_mPreviousScaleY:1,_mPreviousRotation:0,_mPreviousRegistrationX:0,_mPreviousRegistrationY:0,_mPreviousVisibility:false,_mLocalTransform:null,_mLocalTransformNoReg:null,_mLocalTransformDirty:true,_mWorldTransform:null,_mWorldTransformNoReg:null,_mWorldTransformDirty:true,_mRegistrationTransform:null,_mTopLeft:0,_mBottomRight:0,_mAABB:null,_boundingInfoDirty:true,_mWorldAlpha:1,_mIgnoreProperties:false,_mMouseOver:false,_visibilityChanged:false,setLocalTransform:function(j,g,l,k,h,f){var e=this._mLocalTransform._internal;e[0]=j;e[1]=l;e[2]=h;e[3]=g;e[4]=k;e[5]=f;this._mIgnoreProperties=true;this._mLocalTransformDirty=true},useDisplayProperties:function(){this._mIgnoreProperties=false;this._mLocalTransformDirty=true},getBounds:function(){this._checkVisibilityChange();if(this._boundingInfoDirty){this._updateAABB()}return this._mAABB},hitTestPoint:function(a,g){var d=this.x-(this.registrationX*this.width);var b=this.x+((1-this.registrationX)*this.width);var f=this.y-(this.registrationY*this.height);var e=this.y+((1-this.registrationY)*this.height);return(a>this.x-(this.registrationX*this.width))&&(a<this.x+((1-this.registrationX)*this.width))&&(g>this.y-(this.registrationY*this.height))&&(g<this.y+((1-this.registrationY)*this.height))},clearChildren:function(){},markForRemoval:function(){},numChildren:function(a){return 0},isMouseOver:function(){return this._mMouseOver},_draw:function(g){this._checkVisibilityChange();if(!this.visible){return}this._updateTransformations();if(this.stage!==null&&this.mouseEnabled){this.stage._mMouseTargets.push(this)}g.save();var e=this._mWorldTransform._internal;var f=this.stage===null?1:this.stage._mScale;var n=e[0]*f;var l=e[3]*f;var j=e[1]*f;var h=e[4]*f;var o=e[2]*f;var k=e[5]*f;if(this._mIgnoreProperties||this.rotation!==0){g.setTransform(n,l,j,h,o,k)}else{g.setTransform(n,l,j,h,o|0,k|0)}g.globalAlpha=this._mWorldAlpha;if(this.backgroundColor!==null){g.fillStyle=this.backgroundColor;g.fillRect(0,0,this.width,this.height)}this._drawClass(g);g.restore()},_drawClass:function(a){},_updateTransformations:function(){this._mWorldTransformDirty=false;var d=this.x!==this._mPreviousX||this.y!==this._mPreviousY||this.scaleX!==this._mPreviousScaleX||this.scaleY!==this._mPreviousScaleY||this.rotation!==this._mPreviousRotation||this._visibilityChanged;if(d&&!this._mIgnoreProperties){this._visibilityChanged=false;this._mPreviousX=this.x;this._mPreviousY=this.y;this._mPreviousScaleX=this.scaleX;this._mPreviousScaleY=this.scaleY;this._mPreviousRotation=this.rotation;this._mLocalTransformDirty=true}if(this.registrationX!==this._mPreviousRegistrationX||this.registrationY!==this._mPreviousRegistrationY){this._mPreviousRegistrationX=this.registrationX;this._mPreviousRegistrationY=this.registrationY;var b=-this.width*this.registrationX;var e=-this.height*this.registrationY;this._mRegistrationTransform.identity();this._mRegistrationTransform.translate(b,e)}if(this._mLocalTransformDirty){if(!this._mIgnoreProperties){this._mLocalTransform.identity();var a=this._mLocalTransform._internal;a[2]=this.x;a[5]=this.y;if(this.rotation!==0){this._mLocalTransform.rotate(this.rotation)}if(this.scaleX!==1||this.scaleY!==1){a[0]*=this.scaleX;a[1]*=this.scaleY;a[3]*=this.scaleX;a[4]*=this.scaleY}}this._mLocalTransformNoReg.copyFrom(this._mLocalTransform);this._mLocalTransform.concat(this._mRegistrationTransform)}if(this.parent!==null){if(this._mLocalTransformDirty||this.parent._mWorldTransformDirty){this._mWorldTransform.copyFrom(this.parent._mWorldTransformNoReg);this._mWorldTransform.concat(this._mLocalTransform);this._mWorldTransformNoReg.copyFrom(this.parent._mWorldTransformNoReg);this._mWorldTransformNoReg.concat(this._mLocalTransformNoReg);this._mWorldTransformDirty=true}}else{this._mWorldTransform.copyFrom(this._mLocalTransform);this._mWorldTransformDirty=this._mLocalTransformDirty}if(this._mWorldTransformDirty){this._setBoundingInfoDirty()}this._mWorldAlpha=this.parent!==null?this.parent._mWorldAlpha*this.alpha:this.alpha;this._mLocalTransformDirty=false},_updateAABB:function(){this._mTopLeft.x=0;this._mTopLeft.y=0;this._mBottomRight.x=this.width;this._mBottomRight.y=this.height;this._mWorldTransform.transformPoint(this._mTopLeft);this._mWorldTransform.transformPoint(this._mBottomRight);var a=Math.min(this._mTopLeft.x,this._mBottomRight.x);var d=Math.max(this._mTopLeft.x,this._mBottomRight.x);var e=Math.min(this._mTopLeft.y,this._mBottomRight.y);var b=Math.max(this._mTopLeft.y,this._mBottomRight.y);this._mAABB.x=a;this._mAABB.y=e;this._mAABB.width=d-a;this._mAABB.height=b-e;this._boundingInfoDirty=false},_setBoundingInfoDirty:function(){this._boundingInfoDirty=true;if(this.parent!==null){this.parent._setBoundingInfoDirty()}},_checkVisibilityChange:function(){if(this.visible!==this._mPreviousVisibility){this._visibilityChanged=true;this._mPreviousVisibility=this.visible;this._setBoundingInfoDirty()}}};TGE.DisplayObjectContainer=function(){TGE.DisplayObjectContainer.superclass.constructor.call(this);this._mChildren=[];return this};TGE.DisplayObjectContainer.prototype={_mChildren:null,addChild:function(a){if(a.parent!==null){a.parent.removeChild(a)}a.parent=this;a.stage=this.stage;this._mChildren.push(a);return a},getChildAt:function(a){return this._mChildren[a]},getChildByName:function(d,b){b=typeof b==="undefined"?false:b;var a=this._mChildren.length;for(var e=0;e<a;e++){if(this._mChildren[e].instanceName===d){return this._mChildren[e]}if(b){var f=this._mChildren[e].getChildByName(d,true);if(f!==null){return f}}}return null},getChildIndex:function(d){var a=this._mChildren.length;for(var b=0;b<a;b++){if(this._mChildren[b]===d){return b}}return -1},removeChild:function(b){var a=this.getChildIndex(b);if(a!==-1){this._mChildren[a].parent=null;this._mChildren.splice(a,1)}return b},clearChildren:function(){for(var a=this._mChildren.length-1;a>=0;a--){this._mChildren[a].markForRemoval();this._mChildren[a].clearChildren();this._mChildren[a].parent=null;this._mChildren.splice(a,1)}this._mChildren=[]},numChildren:function(a){a=typeof a==="undefined"?false:a;var e=this._mChildren.length;if(a){var d=0;for(var b=0;b<e;b++){d+=1+this._mChildren[b].numChildren(true)}return d}return e},_drawClass:function(b){TGE.DisplayObjectContainer.superclass._drawClass.call(this,b);var a=this._mChildren.length;for(var d=0;d<a;d++){var e=this._mChildren[d];e._checkVisibilityChange();if(e.visible){b.save();e._draw(b);b.restore()}}},_updateAABB:function(){TGE.DisplayObjectContainer.superclass._updateAABB.call(this);var a=this._mChildren.length;for(var b=0;b<a;b++){if(this._mChildren[b].visible){this._mAABB.union(this._mChildren[b].getBounds())}}}};extend(TGE.DisplayObjectContainer,TGE.DisplayObject);TGE.Stage=function(d,f,e){TGE.Stage.superclass.constructor.call(this);this.stage=this;var a=false;if(d){if(d instanceof HTMLDivElement){a=false}else{if(d instanceof HTMLCanvasElement){a=true}else{d=document.body}}}var b;if(a){b=d}else{b=document.createElement("canvas");d.appendChild(b)}this.width=d.clientWidth;this.height=d.clientHeight;this.registrationX=0;this.registrationY=0;b.width=this.width;b.height=this.height;this.width=this._mOriginalWidth=typeof(f)!=="undefined"?f:d.clientWidth;this.height=this._mOriginalHeight=typeof(e)!=="undefined"?e:d.clientHeight;this._mScale=1;this._mCanvas=b;this._mCanvasContext=b.getContext("2d");return this};TGE.Stage.prototype={_mCanvasContext:null,_mMouseTargets:[],draw:function(){this._mMouseTargets=[];this._mCanvasContext.globalAlpha=1;this._mCanvasContext.globalCompositeOperation="source-over";this._draw.call(this,this._mCanvasContext)},setScale:function(a){this._mScale=a;this._mCanvas.width=this._mOriginalWidth*a;this._mCanvas.height=this._mOriginalHeight*a;this.width=this._mOriginalWidth;this.height=this._mOriginalHeight},_notifyObjectsOfMouseEvent:function(e,d,a){for(var b=this._mMouseTargets.length-1;b>=0;b--){var f=this._mMouseTargets[b];if(f.hitTestPoint(d,a)){if(true){switch(e){case"up":f.MouseUp();break;case"down":f.MouseDown();break;case"click":f.Click();break}return}}}},_updateObjectMouseOverStates:function(d,a){for(var b=this._mMouseTargets.length-1;b>=0;b--){var f=this._mMouseTargets[b];var e=f.hitTestPoint(d,a);if(e){f._mMouseOver=true}else{if(f._mMouseOver){f._mMouseOver=false}}}}};extend(TGE.Stage,TGE.DisplayObjectContainer);TGE.Sprite=function(){TGE.Sprite.superclass.constructor.call(this);return this};TGE.Sprite.prototype={_mImage:null,_mCellWidth:0,_mCellHeight:0,_mSpriteIndex:0,_mCoordinateCache:null,setImage:function(g,f,e){f=typeof f==="undefined"?1:f;e=typeof e==="undefined"?1:e;if(typeof g==="string"){g=TGE.AssetManager.GetImage(g)}if(g&&!(g instanceof Image)&&g.spriteSheet){this._mImage=g.spriteSheet;this._mCellWidth=Math.floor(g.width/e);this._mCellHeight=Math.floor(g.height/f);this._mCoordinateCache=[];var b,a;for(var d=0;d<f*e;d++){b=g.x+((d%e)|0)*this._mCellWidth;a=g.y+((d/e)|0)*this._mCellHeight;this._mCoordinateCache.push([b,a])}this.width=this._mCellWidth;this.height=this._mCellHeight}else{if(g instanceof Image){this._mImage=g;this._mCellWidth=Math.floor(g.width/e);this._mCellHeight=Math.floor(g.height/f);this._mCoordinateCache=[];var b,a;for(var d=0;d<f*e;d++){b=((d%e)|0)*this._mCellWidth;a=((d/e)|0)*this._mCellHeight;this._mCoordinateCache.push([b,a])}this.width=this._mCellWidth;this.height=this._mCellHeight}else{this._mImage=null}}this._mSpriteIndex=0},setSpriteIndex:function(a){this._mSpriteIndex=a;if(this._mSpriteIndex>=this._mCoordinateCache.length){TGE.log("***** ERROR: Attempt to call TGE.Sprite.setSpriteIndex with an out of range index ("+a.toString()+")");this._mSpriteIndex=0}},_drawClass:function(a){if(this._mImage!==null&&(this.width!==this._mCellWidth||this.height!==this._mCellHeight)){TGE.log("***** ERROR: You cannot change the width or height properties of a TGE.Sprite object - use scaleX or scaleY instead");this.width=this._mCellWidth;this.height=this._mCellHeight}if(this._mImage!==null){a.drawImage(this._mImage,this._mCoordinateCache[this._mSpriteIndex][0]>>0,this._mCoordinateCache[this._mSpriteIndex][1]>>0,this.width,this.height,0,0,this.width,this.height)}TGE.Sprite.superclass._drawClass.call(this,a)}};extend(TGE.Sprite,TGE.DisplayObjectContainer);TGE.AudioLoader=function(d,b,f,k,g){var j=this;this.id=d;this.loader=null;this.forceHandler=null;this.audio=document.createElement("audio");this.audio.setAttribute("preload","auto");document.body.appendChild(this.audio);if(TGE.BrowserDetect.browser==="Safari"||TGE.BrowserDetect.platform==="Windows Phone"){if(typeof b!=="undefined"){if(f.lastIndexOf("mp3")==f.length-"mp3".length){var e=b;b=f;f=e}}}var a=document.createElement("source");a.setAttribute("src",b);this.audio.appendChild(a);var h=document.createElement("source");h.setAttribute("src",f);this.audio.appendChild(h);this.url=b;this.tags=k;this.priority=g;this.complete=false;this.pollCount=0;this.start=function(n){this.loader=n;if(this.isLimited()){var m=function(){this.audio.pause();this.audio.removeEventListener("play",this.forceHandler,false);this.complete=true;this.loader.onLoad(j);this.audio.play()};this.forceHandler=m.bind(this);this.audio.addEventListener("play",this.forceHandler,false);this.audio.play()}else{var l=function(){this.audio.removeEventListener("loadedmetadata",this.forceHandler,false);this.complete=true;this.loader.onLoad(j)};this.forceHandler=l.bind(this);this.audio.addEventListener("loadedmetadata",this.forceHandler,false);this.audio.load()}};this.checkStatus=function(){if(this.audio.networkState===HTMLMediaElement.NETWORK_NO_SOURCE){this.loader.onError(j);return}if(this.pollCount>=3){this.loader.onTimeout(j);return}if(this.complete===true||TGE.BrowserDetect.platform==="Windows Phone"){this.loader.onLoad(j)}if(this.isLimited()){this.loader.onTimeout(j);return}this.pollCount++};this.onTimeout=function(){this.loader.onTimeout(j)};this.getName=function(){return b}};TGE.AudioLoader.prototype.isLimited=function(){return(TGE.BrowserDetect.platform==="iPhone"||TGE.BrowserDetect.platform==="iPad")};PxLoader.prototype.addAudio=function(g,f,e,a,b){var d=new TGE.AudioLoader(g,f,e,a,b);this.add(d);return d.audio};TGE.AudioManager=function(a){this.mAssetManager=a;this.mVolume=1;this.mMuted=false;this.mplayerManagerList=new Array()};TGE.AudioManager.prototype={Play:function(b){var a=null;if(b.id in this.mplayerManagerList){a=this.mplayerManagerList[b.id]}else{a=new TGE.PlayerManager(this);if(a.init(b)===false){return}this.mplayerManagerList[b.id]=a}if(this.isMobile()==true&&this.mMuted===true){return}a.playAudio(b)},Pause:function(b){if(b in this.mplayerManagerList){var a=this.mplayerManagerList[b];a.pauseAudio()}},Mute:function(){if(this.mMuted===true){return}this.mMuted=true;for(var b in this.mplayerManagerList){var a=this.mplayerManagerList[b];if(this.isMobile()===true){if(a.nLoop==0){a.stopAudio()}else{a.pauseAudio()}}else{a.muteAudio()}}},Unmute:function(){if(this.mMuted===false){return}this.mMuted=false;for(var b in this.mplayerManagerList){var a=this.mplayerManagerList[b];if(this.isMobile()===true){if(a.nLoop!=0){if(a.mState===a.STATE.Stopped){a.playAudio({})}else{a.resumeAudio()}}}else{a.unmuteAudio()}}},ToggleMute:function(){if(this.mMuted===true){this.Unmute()}else{this.Mute()}},StopAll:function(){for(var b in this.mplayerManagerList){var a=this.mplayerManagerList[b];a.stopAudio()}},PauseAll:function(){for(var b in this.mplayerManagerList){var a=this.mplayerManagerList[b];a.pauseAudio()}},ResumeAll:function(){for(var b in this.mplayerManagerList){var a=this.mplayerManagerList[b];if(this.isMobile()==true&&this.mMuted===true){continue}a.resumeAudio()}},isLoadAudio:function(){return this.mAssetManager.mLoadAudio},isMobile:function(){return(TGE.BrowserDetect.platform!=="Windows"&&TGE.BrowserDetect.platform!=="Mac")}};TGE.PlayerManager=function(a){this.mAudioManager=a;this.nStartTime=0;this.nEndTime=-1;this.nLoop=0;this.callback=null;this.audioElement=null;this.bPlaySegment=false;this.STATE={NotLoaded:0,Playing:1,Stopped:2,Paused:3,AutoPaused:4};this.mState=this.STATE.NotLoaded;this.audioId=null;this.audioPlaybackInProgressHandler=null;this.audioPlaybackCompleteHandler=null};TGE.PlayerManager.prototype={init:function(b){this.mState=this.STATE.NotLoaded;this.audioId=b.id;var e=this;this.callback=(b.callBackFunction!==undefined?b.callBackFunction:null);this.audioElement=this.mAudioManager.mAssetManager.getImage(b.id);if(undefined===this.audioElement){TGE.log("Unknown audio id: "+b.id);return false}this.nStartTime=0;this.nEndTime=-1;if("audio_sprite"===this.audioElement.assetType){this.bPlaySegment=true;this.nStartTime=this.audioElement.startTime;this.nEndTime=this.audioElement.endTime;this.audioElement=this.mAudioManager.mAssetManager.getImage(this.audioElement.id)}if(this.audioElement.canPlayType){}else{TGE.log("No canPlayType attribute found in audio tag: "+b.id);return false}this.nLoop=0;if(b.loop!==undefined){this.nLoop=Number(b.loop)}if(this.nLoop===undefined){this.nLoop=0}var d=function(){if(this.bPlaySegment){if(this.audioElement.currentTime<this.nStartTime){this.audioElement.currentTime=this.nStartTime}if(this.audioElement.currentTime>=this.nEndTime){if(this.nLoop===0){this.stopAudio()}else{this.restartAudio()}}}};var a=function(){if(this.nLoop===0){this.stopAudio()}else{this.restartAudio()}};this.audioElement.addEventListener("timeupdate",d.bind(this),false);this.audioElement.addEventListener("ended",a.bind(this),false);window.addEventListener("pagehide",function(){if(e.mState===e.STATE.Playing){e.pauseAudio();e.mState=e.STATE.AutoPaused}});window.addEventListener("pageshow",function(){if(e.mState===e.STATE.AutoPaused){e.resumeAudio()}});this.mState=this.STATE.Stopped;return true},playAudio:function(a){if(this.mAudioManager.isLoadAudio()===false){return}if(this.mAudioManager.mMuted===true){this.audioElement.volume=0}else{this.audioElement.volume=this.mAudioManager.mVolume}try{this.audioElement.currentTime=this.nStartTime}catch(b){TGE.log("Error setting start time, continuing: "+b)}if(this.bPlaySegment===false){this.nEndTime=this.audioElement.duration}this.mState=this.STATE.Playing;this.audioElement.play()},stopAudio:function(){if(this.mAudioManager.isLoadAudio()===false){return}if(undefined===this.audioElement){return}this.mState=this.STATE.Stopped;this.audioElement.pause();this.audioElement.currentTime=0;if(this.callback!==null){this.callback()}},restartAudio:function(){if(this.mAudioManager.isLoadAudio()===false){return}if(undefined===this.audioElement){return}this.mState=this.STATE.Playing;this.audioElement.currentTime=this.nStartTime;this.audioElement.play()},pauseAudio:function(){if(this.mAudioManager.isLoadAudio()===false){return}if(undefined===this.audioElement){return}if(this.mState!==this.STATE.Playing){return}this.mState=this.STATE.Paused;this.audioElement.pause()},resumeAudio:function(){if(this.mAudioManager.isLoadAudio()===false){return}if(undefined===this.audioElement){return}if(this.mState!==this.STATE.Paused){return}this.mState=this.STATE.Playing;this.audioElement.play()},muteAudio:function(){if(this.mAudioManager.isLoadAudio()===false){return}if(undefined===this.audioElement){return}this.audioElement.volume=0},unmuteAudio:function(){if(this.mAudioManager.isLoadAudio()===false){return}if(undefined===this.audioElement){return}this.audioElement.volume=this.mAudioManager.mVolume},};TGE.Game=function(){if(TGE.Game._sInstance!==null){TGE.log("***** ERROR: you can only create one instance of a TGE.Game object");return this}TGE.Game._sInstance=this;this.analytics=null;this.mCanvasDiv=null;this.mReorientationDiv=null;this.mCanvasPosition=null;this.mGameManager=new TGE.ObjectsManager();this.mLayers={};this.mCameraLocation=null;this.mLoadingStartTime=new Date().getTime();this.mLoadingScreen=null;this.stage=null;this.assetManager=new TGE.AssetManager();this.audioManager=new TGE.AudioManager(this.assetManager);this.mPlaying=false;this.mPaused=false;this.mCurrentLevel=null;this.mPauseButton=null;this.mUserPauseEnabled=false;this.mGameTime=0;this.mFilterStrength=10;this.mFrameTime=0;this.mLastLoop=new Date;this.mLastDisplay=new Date;this.mThisLoop;this.mFPSText=null;this.mMaxTickTime=0.1;this.mMinTickTime=Number.MIN_VALUE;this.mUIManager=new TGE.ObjectsManager();this.mScreenManager=new TGE.ScreenManager(this);this.mMouseX=0;this.mMouseY=0;this.mMouseDown=false;this.mKeysDown={};this.mDefaultLinkTarget="_blank";this.canvasWidth=0;this.canvasHeight=0;this._mNativeScaling=null;this._mViewportScale=1;this._oniOS=(TGE.BrowserDetect.platform==="iPhone"||TGE.BrowserDetect.platform==="iPad");this._onAndroid=(TGE.BrowserDetect.platform==="Android")};TGE.Game._sInstance=null;TGE.Game.GetInstance=function(){return TGE.Game._sInstance};TGE.Game.prototype={_mViewportScale:0,_mResizeTimeout:null,_oniOS:false,_onAndroid:false,onMobile:function(){return TGE.BrowserDetect.isMobileDevice},oniOS:function(){return this._oniOS},onAndroid:function(){return this._onAndroid},onPhoneGap:function(){return TGE.BrowserDetect.usingPhoneGap},IsPlatformAcceptable:function(){var b=!!window.CanvasRenderingContext2D;if(!b){this.AnalyticErrorEvent("no canvas");return false}var f=false;if(TGE.BrowserDetect.platform==="iPhone"||TGE.BrowserDetect.platform==="iPad"){var a=TGE.BrowserDetect.OSversion.charCodeAt(0)-48;return a>=5}if(TGE.BrowserDetect.Platform==="Android"){return true}if(TGE.BrowserDetect.platform==="Windows"||TGE.BrowserDetect.platform==="Mac"){var e=TGE.BrowserDetect.browser.toLowerCase();var d=parseFloat(TGE.BrowserDetect.version);if(e=="firefox"){return d>=8}else{if(e=="explorer"){return d>=9}else{if(e=="chrome"){return d>=14}else{if(e=="safari"){return d>=5.1}else{}}}}}return true},_determineCanvasPosition:function(){TGE.debugLog("_determineCanvasPosition");this.mCanvasPosition=getElementPosition(this.mCanvasDiv)},Launch:function(m,e){var l;var f;var b=-1;var n=-1;var d=-1;var g=-1;var k=false;if(this.analytics===null&&this.mAnalytics!=null){this.analytics=this.mAnalytics}if(typeof m==="string"){l=m;f=e}else{l=typeof m.gameDiv==="undefined"?null:m.gameDiv;f=typeof m.reorientDiv==="undefined"?null:m.reorientDiv;b=typeof m.width==="undefined"?-1:m.width;n=typeof m.height==="undefined"?-1:m.height;d=typeof m.initialWidth==="undefined"?-1:parseInt(m.initialWidth);g=typeof m.initialHeight==="undefined"?-1:parseInt(m.initialHeight);k=typeof m.resizeForNative==="undefined"?false:m.resizeForNative}this.mCanvasDiv=document.getElementById(l);if(this.mCanvasDiv==null){TGE.log("***** ERROR: Could not find canvas div '"+l+"'");return false}var a=this.mCanvasDiv.getAttribute("style")||"";this.mCanvasDiv.setAttribute("style",a+" z-index: 1; overflow: hidden; -webkit-user-select: none; -ms-touch-action:none; -webkit-tap-highlight-color: transparent; -moz-tap-highlight-color: transparent; -webkit-transform: translateZ(0);");if(k){var j=document.getElementById("viewporter");if(j!==null){j.align="left"}var h=1;if(TGE.BrowserDetect.platform==="iPad"){h=768/1024;b=this.mCanvasDiv.clientWidth;n=Math.round(h*b)}else{if(TGE.BrowserDetect.platform==="iPhone"){h=320/480;b=this.mCanvasDiv.clientWidth;n=Math.round(h*b);if(j!==null&&(window.innerWidth>480||window.innerHeight>480)){j.align="center"}}}if(h!==1){this._mNativeScaling={x:(b/this.mCanvasDiv.clientWidth),y:(n/this.mCanvasDiv.clientHeight)}}}if(b>0&&n>0){this.mCanvasDiv.style.width=b+"px";this.mCanvasDiv.style.height=n+"px"}this.canvasWidth=this.mCanvasDiv.clientWidth;this.canvasHeight=this.mCanvasDiv.clientHeight;TGE.debugLog("game launch calling _resizeViewport");this._resizeViewport();this.mReorientationDiv=document.getElementById(f);this._determineCanvasPosition();window.addEventListener("resize",this._onResize.bind(this),false);if(this.onMobile()){window.addEventListener("blur",this._onDeactivate.bind(this),false);window.addEventListener("pagehide",this._onDeactivate.bind(this),false);if(this.onPhoneGap()){document.addEventListener("pause",this._onDeactivate.bind(this),false)}}if("ontouchstart" in document.documentElement&&TGE.BrowserDetect.isMobileDevice){this.mCanvasDiv.addEventListener("touchstart",this._mouseDown.bind(this),false);this.mCanvasDiv.addEventListener("touchmove",this._mouseMove.bind(this),false);this.mCanvasDiv.addEventListener("touchend",this._mouseUp.bind(this),false)}else{this.mCanvasDiv.addEventListener("click",this._preventBehavior.bind(this),false);this.mCanvasDiv.addEventListener("mousedown",this._mouseDown.bind(this),false);this.mCanvasDiv.addEventListener("mouseup",this._mouseUp.bind(this),false);this.mCanvasDiv.addEventListener("mousemove",this._mouseMove.bind(this),false)}document.addEventListener("keydown",this._keyDown.bind(this),false);document.addEventListener("keyup",this._keyUp.bind(this),false);if(d>0&&g>0){this.InitializeRenderer(d,g)}else{this.InitializeRenderer()}window.addEventListener("orientationchange",this._onOrientationChanged);if((typeof viewporter!=="undefined")&&(typeof viewporter.preventPageScroll==="function")){viewporter.preventPageScroll=true}this.BeginLoad();return true},_onOrientationChanged:function(){TGE.debugLog("_onOrientationChanged called");if((typeof viewporter!=="undefined")&&(typeof viewporter.refresh==="function")){viewporter.refresh()}},_onResize:function(){TGE.debugLog("_onResize::_mResizeTimeout: "+this._mResizeTimeout);if(this._mResizeTimeout!==null){clearTimeout(this._mResizeTimeout);this._mResizeTimeout=null}if(this.onAndroid()){this._mResizeTimeout=setTimeout(this._resizeViewport.bind(this),500)}else{this._resizeViewport()}},_scaleCanvasDiv:function(d){if(this.stage===null){return}var b=Math.round(this.stage.width*d*1000)/1000;var a=Math.round(this.stage.height*d*1000)/1000;this.mCanvasDiv.style.width=b+"px";this.mCanvasDiv.style.height=a+"px";this._scaleStage(d)},_getBrowserWidth:function(){if(window.innerWidth){return window.innerWidth}if(document.documentElement&&document.documentElement.clientWidth!=0){return document.documentElement.clientWidth}if(document.body){return document.body.clientWidth}return 0},_getBrowserHeight:function(){if(window.innerHeight){return window.innerHeight}if(document.documentElement&&document.documentElement.clientHeight!=0){return document.documentElement.clientHeight}if(document.body){return document.body.clientHeight}return 0},_scaleStage:function(a){this._mViewportScale=a;if(this.stage!==null){this.stage.setScale(this._mViewportScale)}this._determineCanvasPosition()},_centerCanvasDiv:function(b,d,f,a){this.mCanvasDiv.style.position="absolute";if(b){this.mCanvasDiv.style.align="left";this.mCanvasDiv.style.left=((this._getBrowserWidth()/2)-(f/2))+"px";var e=document.getElementById("viewporter");if(e){e.style.align="left"}}if(d){this.mCanvasDiv.style.top=((this._getBrowserHeight()/2)-(a/2))+"px"}},_resizeViewport:function(){TGE.debugLog("_resizeViewport");if(typeof window.canvasScale!=="undefined"){TGE.debugLog("_resizeViewport for JSEmbed using stage scaling");this.scaleStage(window.canvasScale);return}var f=this.mCanvasDiv;var b=f.getAttribute("style")||"";var g=this.canvasWidth;var n=this.canvasHeight;var a=window.innerWidth;var d=window.innerHeight;TGE.debugLog("_resizeViewport::game size: "+g+"x"+n+", \nscreen size: "+a+"x"+d);var m=g<=n;var o=a<=d;var p=o===m;var j={x:1,y:1};j.x=a/g;j.y=d/n;j.x=Math.round(j.x*100)/100;j.y=Math.round(j.y*100)/100;var l=1;var h;if(j.x<j.y){l=j.x;h=true}else{l=j.y;h=false}if(Math.abs(1-l)<=0.01){l=1}var k=g*l;var e=n*l;if(TGE.BrowserDetect.usingPhoneGap){TGE.debugLog("_resizeViewport for native using stage scaling");this._scaleCanvasDiv(l);this._centerCanvasDiv(true,true,k,e);return}if(TGE.BrowserDetect.isMobileDevice){if((TGE.BrowserDetect.platform==="Android"&&parseInt(TGE.BrowserDetect.OSversion.charAt(0))<4)||(TGE.BrowserDetect.oniOS&&TGE.BrowserDetect.OSversion.charAt(0)<6)||(TGE.BrowserDetect.platform==="Kindle Fire")){TGE.debugLog("_resizeViewport for mobile web using stage scaling");this._scaleCanvasDiv(l)}else{TGE.debugLog("_resizeViewport for mobile web using css transform scaling");this._mViewportScale=l;j=l+", "+l;f.setAttribute("style",b+" -ms-transform-origin: left top; -webkit-transform-origin: left top; -moz-transform-origin: left top; -o-transform-origin: left top; transform-origin: left top; -ms-transform: scale("+j+"); -webkit-transform: scale3d("+j+", 1); -moz-transform: scale("+j+"); -o-transform: scale("+j+"); transform: scale("+j+");")}this._centerCanvasDiv(true,true,k,e)}else{if(0){this._scaleCanvasDiv(l);this._centerCanvasDiv(true,true,k,e)}else{this._centerCanvasDiv(true,false,g,n)}}if(this.mReorientationDiv!==null&&TGE.BrowserDetect.isMobileDevice){if(!p){this.mCanvasDiv.style.display="none";this.mReorientationDiv.style.display="block";this.PauseGame(true)}else{this.mReorientationDiv.style.display="none";this.mCanvasDiv.style.display="block"}}this._determineCanvasPosition();if((typeof viewporter!=="undefined")&&(typeof viewporter.refresh==="function")){viewporter.refresh()}},_onDeactivate:function(){if(this.mPlaying){this.PauseGame(true);this.audioManager.Mute()}},InitializeRenderer:function(b,a){this.stage=new TGE.Stage(this.mCanvasDiv,b,a)},BeginLoad:function(){this.assetManager.loadAssetList("loading",null,this.LoadRequiredAssets.bind(this))},LoadRequiredAssets:function(){this.mScreenManager.Initialize(this);this._resizeViewport();var a=null;if(typeof(LoadingScreen)!="undefined"){this.mLoadingScreen=this.ShowScreen(LoadingScreen);a=this.loadRequiredAssetsCallback.bind(this)}this.Update();this.assetManager.loadAssetList("required",a,this.finishedLoadingRequiredAssets.bind(this))},loadRequiredAssetsCallback:function(a){if(this.mLoadingScreen!=null&&typeof(this.mLoadingScreen.UpdateProgress)=="function"){this.mLoadingScreen.UpdateProgress(a)}},finishedLoadingRequiredAssets:function(){var a=Math.round((new Date().getTime()-this.mLoadingStartTime)/1000);this.AnalyticGameEvent("load",a);TGE.debugLog("finishedLoadingRequiredAssets calling _resizeViewport");this._resizeViewport();this.GotoMainMenu()},LoadLevelAssets:function(d,b,a){this.assetManager.loadAssetList("level_"+d.toString(),b,a)},StartLevel:function(a){var b=a==this.mCurrentLevel;this.mCurrentLevel=a;this.subclassSetupLevel(this.mCurrentLevel);this.AnalyticLevelEvent(b?"replay":"start");if(!this.mPlaying||this.mPaused){this.StartPlaying()}},FinishLevel:function(){this.AnalyticLevelEvent("complete");this.subclassFinishLevel()},Replay:function(){this.StartLevel(this.mCurrentLevel)},StartPlaying:function(){this.mGameTime=0;this.mPaused=false;this.mPlaying=true;TGE.Achievements.EnableParterUI(false);this.subclassStartPlaying()},ClearScene:function(){this.mGameManager.Purge();this.mUIManager.Purge();this.mCameraLocation=new TGE.Point();this.stage.clearChildren();this.mFPSText=null;this.SetupLayers();this.mScreenManager.Initialize(this);this.CreateLayer("FPS");var b=this.assetManager.getImage("pause_button",false);if(b!=null&&b.width>0){var a=Math.max(b.width,b.height);this.mPauseButton=this.CreateUIEntity(TGE.ScreenEntity).Setup(this.Width()-a/2,a/2,"pause_button","ScreenManager");this.EnableUserPause()}},SetupLayers:function(){this.mLayers={};this.CreateLayer("TGE_default");this.subclassSetupLayers()},ShowScreen:function(a){return this.mScreenManager.ShowScreen(a)},GotoMainMenu:function(){this.mPaused=false;this.mPlaying=false;this.ClearScene();if(typeof(MainMenu)!="undefined"){this.ShowScreen(MainMenu)}else{this.StartPlaying()}},PauseGame:function(b){var a=typeof(PauseScreen)!="undefined";if(!this.mPlaying||b===this.mPaused||!a){return}this.mPaused=b;this.AnalyticGameEvent(this.mPaused?"pause":"resume",this.mCurrentLevel);this._determineCanvasPosition();if(a){if(this.mPaused){this.ShowScreen(PauseScreen,false);this.DisableUserPause()}else{this.mScreenManager.CloseScreen(PauseScreen);this.EnableUserPause()}}TGE.Achievements.EnableParterUI(this.mPaused)},DisableUserPause:function(){this.mUserPauseEnabled=false;if(this.mPauseButton!=null){this.mPauseButton.Hide()}},EnableUserPause:function(){this.mUserPauseEnabled=true;if(this.mPauseButton!=null){this.mPauseButton.Show()}},Update:function(){var a=(this.mThisLoop=new Date)-this.mLastLoop;this.mFrameTime+=(a-this.mFrameTime)/this.mFilterStrength;this.mLastLoop=this.mThisLoop;this.updateFPSDisplay();a=a/1000;a=Math.max(this.mMinTickTime,a);a=Math.min(this.mMaxTickTime,a);if(!this.mPaused){this.mGameTime+=a}this.mScreenManager.Update(a);this.stage._updateObjectMouseOverStates(this.mMouseX,this.mMouseY);if(!this.mPaused){this.updateObjects(a)}if(this.mPlaying&&!this.mPaused){this.subclassUpdateGame(a)}this._updateObjectsToScreen();requestAnimFrame(this.Update.bind(this));this.stage.draw()},SetConstantTickTime:function(a){this.mMinTickTime=this.mMaxTickTime=a},SetBackgroundColor:function(a){this.stage.backgroundColor=a},CreateLayer:function(a){var b=new TGE.DisplayObjectContainer();this.mLayers[a]=b;b.registrationX=0;b.registrationY=0;this.stage.addChild(b)},CreateWorldEntity:function(b){var a=new b;b.prototype.constructor.apply(a,[this]);this.mGameManager.AddObject(a);return a},CreateUIEntity:function(b){var a=new b;b.prototype.constructor.apply(a,[this]);this.mUIManager.AddObject(a);return a},getLayer:function(a){var b="TGE_default" in this.mLayers?this.mLayers.TGE_default:this.stage;if(a!=null&&a in this.mLayers){b=this.mLayers[a]}return b},ShowFramerateDisplay:function(a,e,d,b){if(this.mFPSText!=null){this.mFPSText.markForRemoval()}this.mFPSText=this.CreateUIEntity(TGE.Text).Setup(a,e,"",d.toString()+"px Arial","center","middle",b,"FPS")},updateFPSDisplay:function(){var a=this.mThisLoop-this.mLastDisplay;if(a<1000){return}this.mLastDisplay=this.mThisLoop;if(this.mFrameTime>0&&this.mFPSText!=null){this.mFPSText.Show();this.mFPSText.text=(Math.round(1000/this.mFrameTime).toFixed(0)+"fps")}},updateObjects:function(a){this.mGameManager.Update(a);this.mUIManager.Update(a)},_updateObjectsToScreen:function(){this.mGameManager._updateObjectsToScreen()},EndGame:function(){if(!this.mPlaying){return}this.mPlaying=false;TGE.Achievements.EnableParterUI(true);var a=Math.round(this.mGameTime);this.AnalyticGameEvent("end",a);this.DisableUserPause();this.subclassEndGame();if(typeof(GameOver)!="undefined"){this.ShowScreen(GameOver)}},CurrentLevel:function(){return this.mCurrentLevel},_processMousePosition:function(a){if(this.mCanvasPosition===null){this._determineCanvasPosition()}this.mMouseX=a.pageX;this.mMouseY=a.pageY;if(a.touches){this.mMouseX=a.touches[0].clientX+document.body.scrollLeft+document.documentElement.scrollLeft;this.mMouseY=a.touches[0].clientY+document.body.scrollTop+document.documentElement.scrollTop}this.mMouseX-=this.mCanvasPosition.x;this.mMouseY-=this.mCanvasPosition.y;this.mMouseX/=this._mViewportScale;this.mMouseY/=this._mViewportScale},_preventBehavior:function(a){a.stopPropagation();a.preventDefault()},_mouseDown:function(b){window.focus();this._processMousePosition(b);this.mMouseDown=true;if(this.mUserPauseEnabled&&this.mPauseButton!=null&&this.mGameTime>0.5){var a=Math.max(this.mPauseButton.Width(),this.mPauseButton.Height());if(this.mMouseX>this.Width()-a&&this.mMouseY<a){this.PauseGame(true);return}}this.stage._notifyObjectsOfMouseEvent("down",this.mMouseX,this.mMouseY);if(!this.mPaused){this.subclassMouseDown()}b.stopPropagation();b.preventDefault()},_mouseUp:function(a){this.mMouseDown=false;this.stage._notifyObjectsOfMouseEvent("up",this.mMouseX,this.mMouseY);if(!this.mPaused){this.subclassMouseUp()}a.stopPropagation();a.preventDefault()},_mouseMove:function(a){this._processMousePosition(a);if(!this.mPaused){this.subclassMouseMove()}a.stopPropagation();a.preventDefault()},MouseX:function(){return this.mMouseX},MouseY:function(){return this.mMouseY},IsMouseDown:function(){return this.mMouseDown},isMouseDown:function(){return this.mMouseDown},_keyDown:function(a){this.mKeysDown[a.keyCode]=true;this.subclassKeyDown(a.keyCode)},_keyUp:function(a){this.mKeysDown[a.keyCode]=false;this.subclassKeyUp(a.keyCode)},isKeyDown:function(a){return this.mKeysDown[a]===true},Width:function(){return this.stage.width},Height:function(){return this.stage.height},GameTime:function(){return this.mGameTime},NumGameObjects:function(){return this.mGameManager.NumObjects()},NumUIObjects:function(){return this.mUIManager.NumObjects()},CameraLocation:function(){return this.mCameraLocation},ScreenX:function(a){return(this.stage.width/2)+(a-this.mCameraLocation.x)},ScreenY:function(a){return(this.stage.height/2)-(a-this.mCameraLocation.y)},GetImage:function(a){return this.assetManager.getImage(a)},OpenURL:function(a){this.AnalyticClickThruEvent(a);window.open(a,this.mDefaultLinkTarget)},PlayGame:function(){this.AnalyticGameEvent("begin");this.subclassPlayGame()},CurrentScore:function(){return 0},subclassSetupLayers:function(){},subclassPlayGame:function(){this.StartLevel(-1)},subclassSetupLevel:function(a){},subclassStartPlaying:function(){},subclassStartLevel:function(){},subclassFinishLevel:function(){},subclassUpdateGame:function(a){},subclassEndGame:function(a){},subclassMouseMove:function(){},subclassMouseDown:function(){},subclassMouseUp:function(){},subclassKeyDown:function(a){},subclassKeyUp:function(a){},AnalyticGameEvent:function(a,b){if(this.analytics!==null){this.analytics.logGameEvent(a,this.mCurrentLevel,b)}},AnalyticShareEvent:function(a){if(this.analytics!==null){this.analytics.logShareEvent(a,this.mCurrentLevel)}},AnalyticLevelEvent:function(a){if(this.analytics!==null){this.analytics.logLevelEvent(a,this.mCurrentLevel,Math.floor(this.mGameTime))}},AnalyticAchievementEvent:function(b,a){if(this.analytics!==null){this.analytics.logAchievementEvent(b,this.mCurrentLevel,a)}},AnalyticErrorEvent:function(a){if(this.analytics!==null){this.analytics.logErrorEvent(a)}},AnalyticClickThruEvent:function(a){if(this.analytics!==null){this.analytics.logClickThruEvent(a,this.mCurrentLevel)}},AnalyticCustomEvent:function(a,b){if(this.analytics!==null){this.analytics.logCustomEvent(a,this.mCurrentLevel,b)}}};TGE.KEY_ARROW_LEFT=37;TGE.KEY_ARROW_RIGHT=39;TGE.KEY_ARROW_UP=38;TGE.KEY_ARROW_DOWN=40;TGE.KEY_SPACEBAR=32;TGE.ObjectsManager=function(){this.mObjectsArray=[]};TGE.ObjectsManager.prototype={AddObject:function(a){this.mObjectsArray.push(a)},Update:function(a){for(var b=this.mObjectsArray.length-1;b>=0;b--){this.mObjectsArray[b].Update(a);if(this.mObjectsArray[b].MarkedForRemoval()){this.mObjectsArray[b].Cleanup();this.mObjectsArray.splice(b,1)}}},_updateObjectsToScreen:function(){for(var a=0;a<this.mObjectsArray.length;a++){this.mObjectsArray[a]._updateScreenPosition()}},Purge:function(){for(var a=this.mObjectsArray.length-1;a>=0;a--){this.mObjectsArray[a].Cleanup();this.mObjectsArray.splice(a,1)}},NumObjects:function(){return this.mObjectsArray.length}};TGE.AssetLoader=function(){this.mAssetList=null;this.mUpdateCallback=null;this.mCompleteCallback=null;return this};TGE.AssetLoader.prototype={loadAssetList:function(n,g,e,d,k){e=typeof e==="string"?e:"";if(e.length>0&&e.charAt(e.length-1)!=="/"){e=e.concat("/")}this.mAssetList=g;this.mUpdateCallback=d;this.mCompleteCallback=k;var m=new PxLoader({statusInterval:3000});var l=0;if(g!==null&&g.list.length>0&&g.loaded===false){for(i=0;i<g.list.length;i++){var h=null;if(g.list[i].assetType==="audio"){if(n.loadAudio){h=m.addAudio(g.list[i].id,e+g.list[i].url,e+g.list[i].backup_url,null,null);l++}}else{if(g.list[i].assetType==="audio_sprite"){h={assetType:"audio_sprite",id:g.list[i].sprite,startTime:g.list[i].startTime,endTime:g.list[i].endTime}}else{if(g.list[i].sheet){var b=g.list[i].sheet;var j=n._mSpriteSheets[b];if(!j){j=m.addImage(e+g.list[i].sheet);if(j!==null){n.addImage(g.list[i].id,j)}n._mSpriteSheets[g.list[i].sheet]=j}var f=TGE.AssetManager.SpriteSheets[this._trimmedFilename(b)];if(f){var a=f[this._trimmedFilename(g.list[i].url)];if(a){h={spriteSheet:j,x:a[0],y:a[1],width:a[2],height:a[3]}}}}else{h=m.addImage(e+g.list[i].url)}}}if(h!==null){n.addImage(g.list[i].id,h)}}m.addProgressListener(TGE.AssetLoader.prototype._loaderCallback.bind(this));m.addCompletionListener(TGE.AssetLoader.prototype._completeCallback.bind(this));m.start()}else{if(this.mUpdateCallback!==null){this.mUpdateCallback(1)}if(this.mCompleteCallback!==null){this.mCompleteCallback.call()}}},_trimmedFilename:function(a){var b=a.lastIndexOf("/")+1;return a.substr(b,a.lastIndexOf(".")-b)},_loaderCallback:function(b){if(b.error){TGE.log("***** ERROR: could not load image '"+b.resource.getName()+"'")}if(this.mUpdateCallback!==null){var a=b.completedCount/b.totalCount;this.mUpdateCallback(a)}},_completeCallback:function(){if(this.mAssetList!==null){this.mAssetList.loaded=true;this.mAssetList=null}if(this.mCompleteCallback!==null){this.mCompleteCallback()}}};TGE.AssetManager=function(a){if(TGE.AssetManager.sAssetManagerInstance!==null){return TGE.AssetManager.sAssetManagerInstance}TGE.AssetManager.sAssetManagerInstance=this;if(a===undefined){a=true}this.rootLocation="";this.useSpriteSheets=false;this.loadAudio=a;this._mSpriteSheets={};return this};TGE.AssetManager.SpriteSheets={};TGE.AssetManager.sAssetManagerInstance=null;TGE.AssetManager.GetImage=function(a){return TGE.AssetManager.sAssetManagerInstance===null?null:TGE.AssetManager.sAssetManagerInstance.getImage(a)};TGE.AssetManager.prototype={_mImageAssetLists:[],_mImageCache:[],assignImageAssetList:function(b,a){this._mImageAssetLists[b]={loaded:false,list:a}},loadAssetList:function(b,e,d){var f=new TGE.AssetLoader();var a=this._mImageAssetLists[b];if(a){f.loadAssetList(this,a,this.rootLocation,e,d)}else{TGE.log("TGE.AssetManager could not locate asset list '"+b+"'");if(d){d.call()}}},addImage:function(b,a){this._mImageCache[b]=a},getImage:function(d,b){b=typeof b==="undefined"?true:b;var a=this._mImageCache[d];if(b&&d!=null&&!a){TGE.log("***** ERROR: TGE.AssetManager.getImage could not find the asset '"+d+"'")}return a}};TGE.SpriteAnimation=function(e,g,d,b,h,f,a){this.mFPS=f;this.mNumberOfFrames=h;this.mLooping=a;this.mAge=0;this.mPaused=false;this.mFinishedCallback=null;this.mFrameOffset=0;this.mCurrentFrame=0;this.mSprite=new TGE.Sprite();this.mSprite.setImage(g,d,b);this.mSprite.visible=false;e.addChild(this.mSprite);this.mSprite.registrationX=e.registrationX;this.mSprite.registrationY=e.registrationY};TGE.SpriteAnimation.prototype={Play:function(a){this.mAge=0;this.mFinishedCallback=a;this.mSprite.setSpriteIndex(0);this.mSprite.visible=true},Pause:function(){this.mPaused=true},Stop:function(){this.mSprite.visible=false},Resume:function(){this.mPaused=false},SetAnimationIndexOffset:function(a){this.mFrameOffset=a},Update:function(a){if(!this.mPaused){this.mAge+=a}var d=1/this.mFPS;var b=Math.floor(this.mAge/d);this.mCurrentFrame=0;if(this.mLooping||b<this.mNumberOfFrames){this.mCurrentFrame=b%this.mNumberOfFrames}else{this.mCurrentFrame=this.mNumberOfFrames-1;if(this.mFinishedCallback!=null){this.mFinishedCallback.call();this.mFinishedCallback=null}}this.mCurrentFrame+=this.mFrameOffset;this.mSprite.setSpriteIndex(this.mCurrentFrame)}};TGE.KeyframedAnimation=function(e,f,d,a,b){this.mAnimationPlayer=e;this.mAnimationID=f;this.mPartInstances=d;this.mLooping=a;this.mFinishedCallback=b;this.mSmoothTransitions=false;this.mAge=0;this.mPaused=false;if(!this.mAnimationPlayer.AnimationExists(f)){this.Cancel();console.log("***** ERROR: keyframed animation not found: '"+f+"'")}return this};TGE.KeyframedAnimation.prototype={Pause:function(){this.mPaused=true},Resume:function(){this.mPaused=false},Update:function(a){if(this.mPaused){return}this.mAge+=a;this.mAnimationPlayer.PosePartInstances(this.mPartInstances,this.mAnimationID,this.mAge,this.mLooping,this.mSmoothTransitions)},Cancel:function(){this.mFinishedCallback=null;this.Pause()}};TGE.KeyframedAnimationPlayer=function(j,f,g,a){var h;var b=null;if(typeof(f)==="undefined"){h=j.data;g=j.imagesFolder;f=j.assetsList;a=j.imageSet;b=typeof(j.spriteSheet)==="string"?j.spriteSheet:null}else{h=j}this.mData=null;this.mPartImages=null;this.mImageTag=(typeof a==="undefined")?null:a;if(h.parts===undefined||h.part_instances===undefined||h.animations===undefined||h.max_children===undefined||h.framerate===undefined){return this}this.mData=h;this.mInverseGlobalScale=1/h.image_scale;if(f){if(typeof(g)==="undefined"){g=""}for(var d in this.mData.parts){if(this.mData.parts.hasOwnProperty(d)){var e=this.mImageTag===null?d:this.mImageTag+"_"+d;if(b!==null){f.push({id:e,url:(g+"/"+d+".png"),sheet:b})}else{f.push({id:e,url:(g+"/"+d+".png")})}}}}return this};TGE.KeyframedAnimationPlayer.prototype={Valid:function(){return this.mData!==null},GetAnimations:function(){return this.Valid()?this.mData.animations:null},NumRequiredPartInstances:function(){return this.Valid()?this.mData.max_children:0},AnimationExists:function(a){return this.Valid()?this.mData.animations[a]!==undefined:false},InitializeImages:function(a){if(this.mPartImages!==null){return}this.mPartImages={};for(var b in this.mData.parts){if(this.mData.parts.hasOwnProperty(b)){var d=this.mImageTag===null?b:this.mImageTag+"_"+b;this.mPartImages[b]=a.GetImage(d)}}},PosePartInstances:function(j,g,o,s,e){if(!this.Valid()){return}var B=this.mData.animations[g];var y=B.frames.length;var t=y/this.mData.framerate;var x=Math.floor(o/t);var z=(!s&&x>=1)?y-1:((o-(x*t))/t)*y;var l=Math.floor(z);var k=B.frames[l];var v=(l+1)%y;var u=B.frames[v];var A=j.length;var q=k.instances.length;for(var r=0;r<A;r++){var m=j[r];if(r>=q){m.visible=false}else{var D=k.instances[r];var f=this.mData.part_instances[D.i];var w=this.mData.parts[f];m.setImage(this.mPartImages[f]);m.registrationX=w.regx;m.registrationY=w.regy;var I=D.a;var G=D.b;var E=D.c;var C=D.d;var H=D.x;var F=D.y;if(e){var h=u.instances[u.instances_map[D.i]];if(h!==undefined){var n=z-l;I=D.a+(h.a-D.a)*n;G=D.b+(h.b-D.b)*n;E=D.c+(h.c-D.c)*n;C=D.d+(h.d-D.d)*n;H=D.x+(h.x-D.x)*n;F=D.y+(h.y-D.y)*n}}I*=this.mInverseGlobalScale;G*=this.mInverseGlobalScale;E*=this.mInverseGlobalScale;C*=this.mInverseGlobalScale;m.setLocalTransform(I,G,E,C,H,F);m.visible=true}}}};TGE.ScreenEntity=function(a){TGE.ScreenEntity.superclass.constructor.call(this);this.mGame=a;this.mAge=0;this.mMarkedForRemoval=false;this.mAnimations=[];this.mCurrentAnimation=null;this.mKeyframedAnimationPlayer=null;this.mAnimationPartInstances=[];this.mCurrentKeyframedAnimation=null;this.mCurrentKeyframedAnimationID=null};TGE.ScreenEntity.prototype={_mCameraCulling:null,Setup:function(b,e,d,a){this.mLayer=a;this.x=b;this.y=e;this.setImage(this.mGame.GetImage(d));this.mGame.getLayer(this.mLayer).addChild(this);return this},SetImage:function(b,d,a){var e=this.mGame.GetImage(b);if(e==null){return}d=typeof d!=="undefined"?d:1;a=typeof a!=="undefined"?a:1;this.setImage(e,d,a)},LoadAnimation:function(j,d,f,e,h,g,b){var a=new TGE.SpriteAnimation(this,this.mGame.GetImage(d),f,e,h,g,b);this.mAnimations[j]=a},PlayAnimation:function(b,a){if(this.mCurrentAnimation==this.mAnimations[b]){return}this.PlayAnimationFromStart(b,a)},PlayAnimationFromStart:function(d,a){var b=this.mAnimations[d];if(b!=null){if(this.mCurrentAnimation!==null){this.mCurrentAnimation.Stop()}this.setImage(null);this.mCurrentAnimation=b;this.mCurrentAnimation.Play(a);this.width=this.mCurrentAnimation.mSprite.width;this.height=this.mCurrentAnimation.mSprite.height}},removeCurrentAnimation:function(){if(this.mCurrentAnimation!==null){this.mCurrentAnimation.Stop()}this.setImage(null);this.mCurrentAnimation=null;this.width=this.height=0;this._boundingInfoDirty=true},InitializeKeyframedAnimations:function(d){this.mKeyframedAnimationPlayer=d;this.mKeyframedAnimationPlayer.InitializeImages(this.mGame);if(this.mCurrentKeyframedAnimation!==null){this.mCurrentKeyframedAnimation.Cancel()}if(this.mAnimationPartInstances.length>0){var b=this.mAnimationPartInstances.length;for(var f=0;f<b;f++){this.mAnimationPartInstances[f].markForRemoval()}}this.mAnimationPartInstances=[];var e=this.mKeyframedAnimationPlayer.NumRequiredPartInstances();for(var f=0;f<e;f++){var a=this.addChild(new TGE.Sprite());a.visible=false;this.mAnimationPartInstances.push(a)}},PlayKeyframedAnimation:function(d,a,b){if(this.mCurrentKeyframedAnimationID===d){return}this.PlayKeyframedAnimationFromStart(d,a,b)},PlayKeyframedAnimationFromStart:function(d,a,b){if(typeof(a)==="undefined"){a=true}if(typeof(b)==="undefined"){b=null}if(this.mCurrentKeyframedAnimation!==null){this.mCurrentKeyframedAnimation.Cancel()}this.mCurrentKeyframedAnimation=new TGE.KeyframedAnimation(this.mKeyframedAnimationPlayer,d,this.mAnimationPartInstances,a,b);this.mCurrentKeyframedAnimationID=d},Age:function(){return this.mAge},Update:function(a){this.mAge+=a;this.subclassUpdate(a);if(this.ShouldBeRemoved()){this.markForRemoval()}if(this.mCurrentAnimation!=null){this.mCurrentAnimation.Update(a)}if(this.mCurrentKeyframedAnimation!==null){this.mCurrentKeyframedAnimation.Update(a)}},Cleanup:function(){this.subclassCleanup();this.clearChildren();if(this.parent!==null){this.parent.removeChild(this)}},markForRemoval:function(){this.mMarkedForRemoval=true;var a=this._mChildren.length;for(var b=0;b<a;b++){this._mChildren[b].markForRemoval()}},MarkedForRemoval:function(){return this.mMarkedForRemoval},ShouldBeRemoved:function(){if(this._mCameraCulling!==null){var a=this.getBounds();if(this._mCameraCulling[0]&&a.y+a.height<0){return true}if(this._mCameraCulling[1]&&a.x>this.mGame.Width()){return true}if(this._mCameraCulling[2]&&a.y>this.mGame.Height()){return true}if(this._mCameraCulling[3]&&a.x+a.width<0){return true}}return this.subclassShouldBeRemoved()},subclassUpdate:function(a){},subclassShouldBeRemoved:function(){return false},subclassCleanup:function(){},_updateScreenPosition:function(){},SetRotation:function(a){this.rotation=a},SetScale:function(b,a){a=typeof a==="undefined"?b:a;this.scaleX=b;this.scaleY=a},SetAlpha:function(a){this.alpha=a},Width:function(){return this.width},Height:function(){return this.height},Show:function(){this.visible=true},Hide:function(){this.visible=false},Visible:function(){return this.visible}};extend(TGE.ScreenEntity,TGE.Sprite);TGE.Button=function(a){TGE.ScreenEntity.call(this,a);this.mouseEnabled=true;this.mState="idle";this.mMouseDown=false;this.mPressFunction};TGE.Button.prototype={Setup:function(b,g,f,e,d,a){this.mNumStates=d;TGE.ScreenEntity.prototype.Setup.call(this,b,g,null,a);this.SetImage(f,1,d);this.mPressFunction=e;this.setButtonState("idle");return this},MouseDown:function(){this.mMouseDown=true},MouseOver:function(){},MouseUp:function(){if(this.mPressFunction!=null&&this.mMouseDown){this.mPressFunction.call(this,this)}this.mMouseDown=false},subclassUpdate:function(a){this.mMouseDown=this.mMouseDown&&this.mGame.IsMouseDown();if(this._mMouseOver){this.setButtonState(this.mMouseDown?"down":"hover")}else{this.setButtonState("idle")}},setButtonState:function(b){if(b==this.mState){return}this.mState=b;var a=0;switch(this.mState){case"disable":a=3;break;case"down":a=2;break;case"hover":a=1;break;case"idle":default:a=0;break}if(a<this.mNumStates){this.setSpriteIndex(a)}}};extend(TGE.Button,TGE.ScreenEntity);TGE.Text=function(a){TGE.Text.superclass.constructor.call(this,a);this.text="";this.font="12px Arial";this.hAlign="center";this.vAlign="middle";this.textColor="#000";return this};TGE.Text.prototype={_mPreviousText:null,_mPreviousFont:null,Setup:function(b,j,g,f,e,h,d,a){TGE.ScreenEntity.prototype.Setup.call(this,b,j,null,a);this.text=g;this.font=f;this.hAlign=e;this.vAlign=h;this.textColor=d;return this},_calculateDimensions:function(b){b.save();b.font=this.font;var a=b.measureText(this.text);this.width=a.width;try{var g=this.font.indexOf("px");var d=this.font.substring(0,g);this.height=parseInt(d,10);this.height+=(this.height/4)>>0}catch(f){this.height=30}b.restore()},_drawClass:function(a){if(this.text===null){return}if(this._mPreviousText!==this.text||this._mPreviousFont!==this.font){this._mPreviousText=this.text;this._mPreviousFont=this.font;this._calculateDimensions(a)}a.font=this.font!==null?this.font:"Arial";a.textAlign=this.hAlign!==null?this.hAlign:"center";a.textBaseline=this.vAlign!==null?this.vAlign:"middle";a.fillStyle=this.textColor!==null?this.textColor:"#000";a.fillText(this.text,0,0)}};extend(TGE.Text,TGE.ScreenEntity);TGE.GameWorldEntity=function(a){TGE.ScreenEntity.call(this,a);this.worldPosition=new TGE.Point()};TGE.GameWorldEntity.prototype={_mLockXPosition:false,Setup:function(b,e,d,a){this.mLayer=a;this.SetWorldPosition(b,e);this.setImage(this.mGame.GetImage(d));this.mGame.getLayer(this.mLayer).addChild(this);return this},SetWorldPosition:function(a,b){this.worldPosition.x=a;this.worldPosition.y=b},CullToCamera:function(e,b,a,d){this._mCameraCulling=[e,b,a,d]},WorldPosition:function(){return this.mWorldPosition},LockXPosition:function(){this._mLockXPosition=true},_updateScreenPosition:function(){var a=this._mLockXPosition?this.worldPosition.x:this.mGame.ScreenX(this.worldPosition.x);var b=this.mGame.ScreenY(this.worldPosition.y);this.x=a;this.y=b}};extend(TGE.GameWorldEntity,TGE.ScreenEntity,null);TGE.Screen=function(a){this.mScreenManager=a;this.mBackground=null;this.mUIElements=new Array();this.mDestroyed=false};TGE.Screen.prototype={Setup:function(){},Close:function(){this.mScreenManager.CloseScreen(this.constructor)},Game:function(){return this.mScreenManager.Game()},CreateUIEntity:function(a){var b=this.mScreenManager.CreateUIEntity(a);this.mUIElements.push(b);return b},DisplayNumber:function(b,j,h,o,f,g,q,u){var m=this.CreateUIEntity(TGE.ScreenEntity).Setup(j,h,null,u);var a=b.toString();var d=24;var p=2;var e=a.length*f;if(q){var s=Math.floor((a.length-1)/3);e+=s*d;e-=s*p}var l=g=="center"?e/2+f/2:e;l-=f;var k=0;var r=0;for(i=a.length-1;i>=0;i--){if(q&&r==3){l+=p;var t=new TGE.Sprite();t.setImage("big_digits_comma");t.x=l;t.y=k;m.addChild(t);l-=d;r=0}var n=new TGE.Sprite();n.setImage(o,1,10);n.setSpriteIndex(a.charCodeAt(i)-48);n.x=l;n.y=k;m.addChild(n);l-=f;r++}return m},FillBackground:function(a){this.mBackground=this.mScreenManager.Game().CreateUIEntity(TGE.ScreenEntity);this.mBackground.Setup(0,0,null,this.mScreenManager.mLayerName);this.mBackground.registrationX=0;this.mBackground.registrationY=0;this.mBackground.width=this.mScreenManager.Game().Width();this.mBackground.height=this.mScreenManager.Game().Height();this.mBackground.backgroundColor=a},Finalize:function(){},ShowAll:function(){for(var a=0;a<this.mUIElements.length;a++){this.mUIElements[a].Show()}},HideAll:function(){for(var a=0;a<this.mUIElements.length;a++){this.mUIElements[a].Hide()}},Update:function(a){},Destroy:function(){if(this.mBackground!=null){this.mBackground.markForRemoval()}for(var a=0;a<this.mUIElements.length;a++){this.mUIElements[a].markForRemoval()}this.mDestroyed=true}};TGE.ScreenManager=function(a){this.mGame=a;this.mLayerName="ScreenManager";this.mScreens=new Array();this.mFadeIn=null;this.mFadeInAlpha=1;this.mFadeInSpeed=1;this.mFadeInColor=null};TGE.ScreenManager.prototype={Initialize:function(b){for(var a in this.mScreens){if(this.mScreens[a]!=null){this.mScreens[a].Destroy();this.mScreens[a]=null}}b.CreateLayer(this.mLayerName);b.CreateLayer("FadeOverlay")},setupFadeIn:function(a,b){this.mFadeInSpeed=b;this.mFadeInColor=a},CreateUIEntity:function(a){return this.mGame.CreateUIEntity(a)},ShowScreen:function(e,a){var b=new e;e.prototype.constructor.apply(b,[this]);var d=e.className?e.className():e.name;this.mScreens[d]=b;b.Setup();b.Finalize();a=typeof a==="undefined"?true:a;if(a!=false){this.ResetFade()}return b},CloseScreen:function(d){var b=d.className?d.className():d.name;var a=this.mScreens[b];if(a==null){return}a.Destroy();this.mScreens[d]=null},ResetFade:function(){if(this.mFadeInColor!==null){if(this.mFadeIn===null){this.mFadeIn=new TGE.DisplayObject();this.mFadeIn.width=this.mGame.Width();this.mFadeIn.height=this.mGame.Height();this.mFadeIn.registrationX=0;this.mFadeIn.registrationY=0;this.mFadeIn.backgroundColor=this.mFadeInColor;this.mGame.getLayer("FadeOverlay").addChild(this.mFadeIn)}if(this.mGame.getLayer("FadeOverlay").getChildIndex(this.mFadeIn)===-1){this.mGame.getLayer("FadeOverlay").addChild(this.mFadeIn)}this.mFadeInAlpha=1;this.mFadeIn.alpha=1;this.mFadeIn.visible=true}},Update:function(b){if(this.mFadeIn!==null&&this.mFadeInColor!==null){this.mFadeInAlpha-=b/this.mFadeInSpeed;if(this.mFadeInAlpha<=0){this.mFadeInAlpha=0;this.mFadeIn.visible=false}this.mFadeIn.alpha=this.mFadeInAlpha}for(var a in this.mScreens){if(this.mScreens[a]!=null){this.mScreens[a].Update(b)}}},Game:function(){return this.mGame},XFromPercentage:function(a){return this.mGame.Width()*a},YFromPercentage:function(a){return this.mGame.Height()*a},FixedDistanceFromTop:function(a){return a},FixedDistanceFromBottom:function(a){return this.mGame.Height()-a},FixedDistanceFromLeft:function(a){return a},FixedDistanceFromRight:function(a){return this.mGame.Width()-a}};TGE.Analytics=function(a){this.gameName=a;return this};TGE.Analytics.prototype={logGameEvent:function(a,f,b){var e=this.gameName;if((a=="pause"||a=="resume")&&f!=null&&f>0){e+=(" - level "+f.toString())}var d="ANALYTIC EVENT: game, "+a+", "+e;if(a=="load"||a=="end"){d+=(", "+b.toString())}TGE.log(d)},logShareEvent:function(a,e){var d=this.gameName;if(e!=null&&e>0){d+=(" - level "+e.toString())}var b="ANALYTIC EVENT: share, "+a+", "+d;TGE.log(b)},logLevelEvent:function(a,f,b){var e=this.gameName;if(f!=null&&f>0){e+=(" - level "+f.toString())}var d="ANALYTIC EVENT: level, "+a+", "+e;if((a=="complete"||a=="fail")&&b!=null){d+=(", "+b.toString())}TGE.log(d)},logAchievementEvent:function(b,f,a){var e=this.gameName;if(f!=null&&f>0){e+=(" - level "+f.toString())}var d="ANALYTIC EVENT: achievement, "+b+", "+e;if(a!=null){d+=(", "+a.toString())}TGE.log(d)},logErrorEvent:function(b){var a="ANALYTIC EVENT: error, "+b+", "+this.gameName;TGE.log(a)},logClickThruEvent:function(a,e){var d=this.gameName;if(e!=null&&e>0){d+=(" - level "+e.toString())}var b="ANALYTIC EVENT: clickthru, "+a+", "+d;TGE.log(b)},logCustomEvent:function(a,f,b){var e=this.gameName;if(f!=null&&f>0){e+=(" - level "+f.toString())}var d="ANALYTIC EVENT: custom, "+a+", "+e;if(b!=null){d+=(", "+b.toString())}TGE.log(d)}};TGE.GoogleAnalytics=function(a,b){TGE.GoogleAnalytics.superclass.constructor.call(this,a);if(TGE.BrowserDetect.usingPhoneGap){if(window.plugins&&window.plugins.gaPlugin){this._gaPlugin=window.plugins.gaPlugin;this._gaPlugin.init(null,this._logError,b,10)}else{TGE.log("***** ERROR: PhoneGap GoogleAnalytics plugin was not found")}}return this};TGE.GoogleAnalytics.prototype={_gaPlugin:null,logGameEvent:function(h,a,k){try{var f=this.gameName;if((h=="pause"||h=="resume")&&a!=null&&a>0){f+=(" - level "+a.toString())}var l="game";var g=h;var b=f;var d=k;this._trackEvent(l,g,b,d)}catch(j){this._logError(j.toString())}},logShareEvent:function(b,k){try{var h=this.gameName;if(k!=null&&k>0){h+=(" - level "+k.toString())}var a="share";var g=b;var d=h;var j=null;this._trackEvent(a,g,d,j)}catch(f){this._logError(f.toString())}},logLevelEvent:function(j,a,g){try{var f=this.gameName;if(a!=null&&a>0){f+=(" - level "+a.toString())}var l="level";var h=j;var b=f;var d;if(j=="complete"||j=="fail"&&g!=null){d=g}this._trackEvent(l,h,b,d)}catch(k){this._logError(k.toString())}},logAchievementEvent:function(f,a,k){try{var g=this.gameName;if(a!=null&&a>0){g+=(" - level "+a.toString())}var l="achievement";var h=f;var b=g;var d=k;this._trackEvent(l,h,b,d)}catch(j){this._logError(j.toString())}},logErrorEvent:function(h){try{var a="error";var f=h;var b=this.gameName;var g=null;this._trackEvent(a,f,b,g)}catch(d){this._logError(d.toString())}},logClickThruEvent:function(b,k){try{var h=this.gameName;if(k!=null&&k>0){h+=(" - level "+k.toString())}var a="clickthru";var g=b;var d=h;var j=null;this._trackEvent(a,g,d,j)}catch(f){this._logError(f.toString())}},logCustomEvent:function(h,a,k){try{var f=this.gameName;if(a!=null&&a>0){f+=(" - level "+a.toString())}var l="custom";var g=h;var b=f;var d=k;this._trackEvent(l,g,b,d)}catch(j){this._logError(j.toString())}},_trackEvent:function(a,d,b,e){if(this._gaPlugin!==null){if(typeof e!=="number"){e=-1}this._gaPlugin.trackEvent(this._logResult,this._logError,a,d,b,e)}else{}},_logError:function(a){TGE.log("***** ERROR: TGE.GoogleAnalytics - "+a)},_logResult:function(a){}};extend(TGE.GoogleAnalytics,TGE.Analytics);TGE.ParallaxPane=function(a){TGE.ParallaxPane.superclass.constructor.call(this,a);this.mTrackingSpeed=1;this.mPane1=null;this.mPane2=null;this.mHorizontalOffset=0;this.mWorldY=0};TGE.ParallaxPane.prototype={Setup:function(a,e,d,b){TGE.ScreenEntity.prototype.Setup.call(this,0,0,null,b);this.mWorldY=a;this.registrationX=0;this.registrationY=0;this.mTrackingSpeed=e;this.mPane1=new TGE.Sprite();this.mPane1.setImage(this.mGame.GetImage(d));this.addChild(this.mPane1);this.mPane1.x=0;this.mPane1.y=0;this.mPane1.registrationX=0;this.mPane1.registrationY=0;this.mPane2=new TGE.Sprite();this.mPane2.setImage(this.mGame.GetImage(d));this.addChild(this.mPane2);this.mPane2.x=this.mGame.Width();this.mPane2.y=0;this.mPane2.registrationX=0;this.mPane2.registrationY=0;return this},SetHorizontalOffset:function(a){this.mHorizontalOffset=a},_updateScreenPosition:function(){var d=this.mGame.CameraLocation().x;var a=(-d+this.mHorizontalOffset)*this.mTrackingSpeed/this.scaleX;var b=this.mGame.Width()/this.scaleX;this.mPane1.x=a%b;this.mPane1.y=this.mGame.ScreenY(this.mWorldY);this.mPane2.x=this.mPane1.x+b;this.mPane2.y=this.mGame.ScreenY(this.mWorldY)}};extend(TGE.ParallaxPane,TGE.ScreenEntity);TGE.VerticalParallaxPane=function(a){TGE.VerticalParallaxPane.superclass.constructor.call(this,a);this.mTrackingSpeed=1;this.mPane1=null;this.mPane2=null;this.mVerticalOffset=0};TGE.VerticalParallaxPane.prototype={Setup:function(d,b,a){TGE.ScreenEntity.prototype.Setup.call(this,0,0,null,a);this.registrationX=0;this.registrationY=0;this.mTrackingSpeed=d;this.mPane1=new TGE.Sprite();this.mPane1.setImage(this.mGame.GetImage(b));this.addChild(this.mPane1);this.mPane1.x=0;this.mPane1.y=0;this.mPane1.registrationX=0;this.mPane1.registrationY=0;this.mPane2=new TGE.Sprite();this.mPane2.setImage(this.mGame.GetImage(b));this.addChild(this.mPane2);this.mPane2.x=0;this.mPane2.y=this.mGame.Height();this.mPane2.registrationX=0;this.mPane2.registrationY=0;return this},_updateScreenPosition:function(){var d=this.mGame.CameraLocation().y;var b=(d+this.mVerticalOffset)*this.mTrackingSpeed/this.scaleY;var a=this.mGame.Height()/this.scaleY;this.mPane1.x=0;this.mPane1.y=b%a;this.mPane2.x=0;this.mPane2.y=this.mPane1.y-a}};extend(TGE.VerticalParallaxPane,TGE.ScreenEntity);TGE.Advertisement=function(a){this.element=a.element==="undefined"?null:a.element;this.closeCallback=a.closeCallback==="undefined"?null:a.closeCallback};TGE.Advertisement.prototype={close:function(){if(this.element!==null&&this.element.parentNode!==null){this.element.parentNode.removeChild(this.element)}if(this.closeCallback!==null){this.closeCallback.call()}}};TGE.Advertisement.DisplayAd=function(d){var g=d.parentDiv;var b=d.adWidth;var e=d.adHeight;var a=typeof d.x==="undefined"?(g.clientWidth-b)/2:d.x;var j=typeof d.y==="undefined"?(g.clientHeight-e)/2:d.y;var h=typeof d.closeCallback==="undefined"?null:d.closeCallback;var f=null;if(TGE.BrowserDetect.platform==="Android"&&TGE.BrowserDetect.browser==="Mozilla"&&TGE.BrowserDetect.OSversion==="4.0"){f=null}else{if(getDistributionPartner()==="A0009"){f=null}else{f=document.createElement("div");f.style.position="absolute";f.style.zIndex=3;f.style.left=a.toString()+"px";f.style.top=j.toString()+"px";f.style.width=b.toString()+"px";f.style.height=e.toString()+"px";f.style.overflow="hidden";f.style.border="none";g.insertBefore(f,g.firstChild);f.innerHTML="<object type='text/html' width='"+b+"px' height='"+(e+4).toString()+"px' data='"+d.adURL+"'></object>"}}return new TGE.Advertisement({element:f,closeCallback:h})};TGE.Advertisement.DisplayModalOverlayAd=function(f){var g=f.parentDiv;var r=f.adWidth;var t=f.adHeight;var h=typeof f.skipDelay==="undefined"?0:f.skipDelay;var j=typeof f.headerText==="undefined"?"This game sponsored by:":f.headerText;var k=typeof f.overlayRed==="undefined"?1:f.overlayRed;var u=typeof f.overlayGreen==="undefined"?1:f.overlayGreen;var q=typeof f.overlayBlue==="undefined"?1:f.overlayBlue;var p=typeof f.overlayOpacity==="undefined"?1:f.overlayOpacity;var e=typeof f.closeCallback==="undefined"?null:f.closeCallback;if(TGE.BrowserDetect.platform==="Android"&&TGE.BrowserDetect.browser==="Mozilla"&&TGE.BrowserDetect.OSversion==="4.0"){if(e!==null){e.call()}return}if(getDistributionPartner()==="A0009"){if(e!==null){e.call()}return}var n=document.createElement("div");n.id="ad_overlay";n.style.zIndex=3;n.style.position="absolute";n.style.width=g.clientWidth+"px";n.style.height=g.clientHeight+"px";n.style.backgroundColor="rgba("+Math.round(k*255).toString()+","+Math.round(u*255).toString()+","+Math.round(q*255).toString()+","+p.toString()+")";g.insertBefore(n,g.firstChild);var s=null;if(typeof f.closeButton==="string"){var b=30;s=document.createElement("div");s.id="tge_ad_close_button";s.style.position="absolute";s.style.display="none";var l=Math.round(g.clientWidth*0.0156);var d=g.clientWidth-l-b;s.style.top=l.toString()+"px";s.style.left=d.toString()+"px";s.innerHTML="<img src='"+f.closeButton+"'>";s.style.cursor="pointer";n.insertBefore(s,n.firstChild)}var b=30;var o=document.createElement("div");o.id="tge_ad_resume_button";o.style.position="absolute";o.style.display="none";var l=Math.round(g.clientHeight*0.904);var d=(g.clientWidth-(300+2))/2;o.style.top=l.toString()+"px";o.style.left=d.toString()+"px";o.style.width="300px";o.style.marginLeft="auto";o.style.marginRight="auto";o.style.textAlign="center";o.style.paddingTop="6px";o.style.paddingBottom="6px";o.style.backgroundColor="#f00";o.style.border="solid 1px #444";o.style.borderRadius="5px";o.style.color="#fff";o.style.fontSize="17px";o.style.fontWeight="bold";o.innerHTML="Resume Game Play";o.style.cursor="pointer";n.insertBefore(o,n.firstChild);var a=!TGE.BrowserDetect.isMobileDevice||TGE.BrowserDetect.platform==="Windows Phone"?"click":"touchstart";if(s!==null){s.addEventListener(a,TGE.Advertisement._CloseAd.bind(this,n,e),false)}o.addEventListener(a,TGE.Advertisement._CloseAd.bind(this,n,e),false);if(h>0){setTimeout(TGE.Advertisement._ShowOverlayCloseButtons.bind(this,n),h*1000)}else{TGE.Advertisement._ShowOverlayCloseButtons(n)}n.addEventListener("click",TGE.Advertisement._BlockEvent,false);n.addEventListener("mousedown",TGE.Advertisement._BlockEvent,false);n.addEventListener("mouseup",TGE.Advertisement._BlockEvent,false);n.addEventListener("mousemove",TGE.Advertisement._BlockEvent,false);var m=document.createElement("div");m.id="ad_div";m.style.position="absolute";var l=(g.clientHeight-(t+70))/2;m.style.top=l.toString()+"px";m.style.marginLeft="auto";m.style.marginRight="auto";m.style.width="100%";m.style.overflow="hidden";m.style.color="#333";m.style.fontSize="20px";m.style.fontWeight="bold";m.style.textAlign="center";n.insertBefore(m,n.firstChild);m.innerHTML="<div style='padding-bottom: 15px;'>"+j+"</div><object type='text/html' width='"+r+"px' height='"+(t+4).toString()+"px' data='"+f.adURL+"'></object><div style='color: #666; font-size: 10px; font-weight: normal; padding-left: "+(r-72).toString()+"px;'>Advertisement</div>"};TGE.Advertisement.DisplayChildBrowserAd=function(a){window.plugins.childBrowser.onClose=a.closeCallback;window.plugins.childBrowser.showWebPage(a.adURL,{showLocationBar:true,showAddress:false,showNavigationBar:true})};TGE.Advertisement._CloseAd=function(a,d,b){a.parentNode.removeChild(a);if(d!==null){d.call()}};TGE.Advertisement._ShowOverlayCloseButtons=function(b){var a=document.getElementById("tge_ad_close_button");if(a!=null){a.style.display="block"}var d=document.getElementById("tge_ad_resume_button");if(d!=null){d.style.display="block"}};TGE.Advertisement._BlockEvent=function(a){a.stopPropagation();a.preventDefault();a.stopImmediatePropagation();return false};TGE.Achievement=function(e,b,d,a){this._id=e;this._earned=false;this.name=b;this.description=d;this.imageID=a;return this};TGE.Achievement.prototype={_id:null,earned:function(){this._earned=true},hasBeenEarned:function(){return this._earned},id:function(){return this._id}};TGE.Achievements=function(){this.lockedIconID=null;this.earnedAchievementCallback=null;return this};TGE.Achievements.HigherScoresAreBetter=true;TGE.Achievements.BestScore=null;TGE.Achievements._FRIENDSTER_API_URL="http://www.littlegrey.net/temp/tresensa/friendster";TGE.Achievements.SubmitScore=function(d){var b=new TGE.Achievements();b.submitScore(d)};TGE.Achievements.ShowAchievementsScreen=function(a){if(getDistributionPartner()==="A0014"&&typeof MNDirect!=="undefined"){TGE.PlayPhoneWrapper.showAchievementsScreen()}else{a.call()}};TGE.Achievements.EnableParterUI=function(a){if(getDistributionPartner()==="A0014"){if(a){TGE.PlayPhoneWrapper.showDashboardButton()}else{TGE.PlayPhoneWrapper.hideDashboardButton()}}};TGE.Achievements.prototype={_achievements:[],_achievementIDs:[],createAchievement:function(e,b,d,a){this._achievements[e]=new TGE.Achievement(e,b,d,a);this._achievementIDs.push(e)},saveCompletedAchievements:function(){var g="";var b=this._achievementIDs.length;for(var d=0;d<b;d++){var e=this.getAchievementAt(d);if(e.hasBeenEarned()){g+=d;g+=" "}}var k="";b=g.length;for(c=0;c<b;c++){if(g.charAt(c)===" "){k+=Math.floor(Math.random()*10).toString()}else{k+=String.fromCharCode(g.charCodeAt(c)+50)}}if(k.length>0){var j=new Date();var f=999;j.setDate(j.getDate()+f);var h=k+((f==null)?"":"; expires="+j.toUTCString());document.cookie="tgeachv1="+h}},loadCompletedAchievements:function(){var e=null;var f,l,j,g=document.cookie.split(";");for(f=0;f<g.length;f++){l=g[f].substr(0,g[f].indexOf("="));j=g[f].substr(g[f].indexOf("=")+1);l=l.replace(/^\s+|\s+$/g,"");if(l=="tgeachv1"){e=j}}if(e){var d="";len=e.length;for(c=0;c<len;c++){var h=e.charCodeAt(c);if(e.charCodeAt(c)<=57){d+=" "}else{d+=String.fromCharCode(e.charCodeAt(c)-50)}}var b=d.split(" ");for(var k=0;k<b.length;k++){if(b[k].length>0){this.earnedAchievementAt(parseInt(b[k]),true)}}}},clearAchievements:function(){var d=new Date();var a=999;d.setDate(d.getDate()+a);var b=""+((a==null)?"":"; expires="+d.toUTCString());document.cookie="tgeachv1="+b},numberOfAchievements:function(){return this._achievementIDs.length},getAchievement:function(a){return this._achievements[a]},getAchievementAt:function(a){return this.getAchievement(this._achievementIDs[a])},earnedAchievementAt:function(b,a){this.earnedAchievement(this._achievementIDs[b],a)},earnedAchievement:function(d,b){b=typeof b==="undefined"?false:b;var a=this._achievements[d];if(a){if(!a.hasBeenEarned()){a.earned();if(!b&&this.earnedAchievementCallback){this.earnedAchievementCallback.call(null,a)}this.submitAchievementToPartner(a,b);this.saveCompletedAchievements()}}},submitScore:function(e){var a=false;if(TGE.Achievements.BestScore===null){TGE.Achievements.BestScore=e;a=false}else{if(TGE.Achievements.HigherScoresAreBetter&&e>TGE.Achievements.BestScore){TGE.Achievements.BestScore=e;a=true}else{if(!TGE.Achievements.HigherScoresAreBetter&&e<TGE.Achievements.BestScore){TGE.Achievements.BestScore=e;a=true}}}if(getDistributionPartner()==="A0009"&&parent.kongregate){parent.kongregate.stats.submit("highscore",e)}else{if(getDistributionPartner()==="A0010"){var m=parseInt(getQueryString()["user"]);var h=parseInt(getQueryString()["hid"]);if(!isNaN(m)&&!isNaN(h)&&m>0&&h>=0){var l=Sha1.hash(h.toString()+e.toString()+"troisdixchix"+m.toString());var b="http://www.digyourowngrave.com/high_scores/exclusive/auto_submit_score.php?user_id="+m+"&game_id="+h+"&score="+e+"&key="+l;var k=document.createElement("img");k.src=b}}else{if(getDistributionPartner()==="A0013"){var j=getQueryString()["session_key"];var g=getQueryString()["gameName"];if(j&&g){var f=new FriendsterSocialLeaderBoard();var d={id:getQueryString()["user_id"],score:e,sessionKey:j,gameName:g};f.AutoSubmitScore(d);if(a){var b=TGE.Achievements._FRIENDSTER_API_URL+"/richwallpost.php?gameName="+g+"&score="+e+"&session_key="+j;var k=document.createElement("img");k.src=b}}}else{if(getDistributionPartner()==="A0014"){TGE.PlayPhoneWrapper.submitScore(e)}else{if(TGE.BrowserDetect.usingPhoneGap&&TGE.BrowserDetect.oniOS){}}}}}},submitAchievementToPartner:function(l,h){if(l){if(getDistributionPartner()==="A0009"&&parent.kongregate){parent.kongregate.stats.submit(l.id(),1)}else{if(getDistributionPartner()==="A0010"){var a=parseInt(getQueryString()["aid"]);var n=parseInt(getQueryString()["user"]);if(!isNaN(a)&&!isNaN(n)&&a>=0&&n>0){var j=this._achievementIDs.indexOf(l.id());if(j>=0){var k=a+j;var m=Sha1.hash(k.toString()+"troisdixchix"+n.toString());var b="http://www.digyourowngrave.com/high_scores/exclusive/auto_submit_achievement.php?user_id="+n+"&achievement="+k+"&key="+m;var f=document.createElement("img");f.src=b}}}else{if(!h&&getDistributionPartner()==="A0013"){var e=getQueryString()["session_key"];var d=getQueryString()["gameName"];if(e&&d){var g=encodeURIComponent(l.name);var b=TGE.Achievements._FRIENDSTER_API_URL+"/richwallpost.php?gameName="+d+"&achv="+g+"&session_key="+e;var f=document.createElement("img");f.src=b}}else{if(getDistributionPartner()==="A0014"){var j=this._achievementIDs.indexOf(l.id());TGE.PlayPhoneWrapper.achievementEarned(j)}else{if(TGE.BrowserDetect.usingPhoneGap&&TGE.BrowserDetect.oniOS){}}}}}}}};function FriendsterSocialLeaderBoard(){this.config={SERVER_URL:"http://prod.tresensa.com:8585",ErrorHandler:null};this.loginDetails=[{social_network:"friendster",id:""}];this.userConfiguration={SERVER_URL:this.config.SERVER_URL,APP_URL:this.config.APP_URL,APP_KEY:this.config.APP_KEY,APP_ID:this.config.APP_ID,GameCode:this.config.GameCode,ErrorHandler:this.config.ErrorHandler,SocialNetwork:String(this.config.SocialNetwork).toLowerCase()};return this}FriendsterSocialLeaderBoard.prototype={GetUserDetails:function(b){var a={id:"",sessionKey:+"",score:+""};b(a)},AutoSubmitScore:function(b){for(var d=0;d<this.loginDetails.length;d++){var a={};a.sParams="";a.sParams+="avatar_id="+b.id;a.sParams+="&session_key="+b.sessionKey;a.sParams+="&game_name="+b.gameName;a.sParams+="&score="+b.score;a.sURL=this.userConfiguration.SERVER_URL+"/FriendSterApp/LeaderBoard",a.requestType="POST";a.callback=function(){};this.sendMessage(a)}},SubmitScore:function(b){var a={};a.sParams="";a.sParams+="avatar_id="+b.id;a.sParams+="&session_key="+b.sessionKey;a.sParams+="&game_name="+this.userConfiguration.GameCode;a.sParams+="&score="+b.score;a.sURL=this.userConfiguration.SERVER_URL+"/FriendSterApp/LeaderBoard",a.requestType="POST";a.callback=b.callback;this.sendMessage(a)},GetLeaderboard:function(b){if(b.id!="undefined"&&b.id!=undefined){var a={};a.sParams="";a.sParams+="avatar_id="+b.id;a.sParams+="&session_key="+b.sessionKey;a.sParams+="&game_name="+this.userConfiguration.GameCode;a.sURL=this.userConfiguration.SERVER_URL+"/FriendSterApp/LeaderBoard?"+a.sParams,a.requestType="GET";a.callback=b.callback;this.sendMessage(a)}else{this.userConfiguration.ErrorHandler("backend-error")}},sendMessage:function(f,d){var g;var h=this;var b=f;var a=d;if(window.XDomainRequest){this.xdr=new XDomainRequest();if(this.xdr){this.xdr.onerror=this.err.bind(this);this.xdr.ontimeout=this.timeo.bind(this);this.xdr.onprogress=this.progres.bind(this);this.xdr.onload=function(){var e=h.xdr.responseText;var k=JSON.parse(e);if(k.Error==undefined&&k.Error==null){b.callback(k);if(a!=undefined){h.updateLoginDetails(k)}}else{h.userConfiguration.ErrorHandler("backend-error")}};this.xdr.timeout="2000";this.xdr.open(b.requestType,b.sURL+"?"+b.sParams);this.xdr.send()}else{this.userConfiguration.ErrorHandler("backend-error")}}else{if(window.XMLHttpRequest){g=new XMLHttpRequest()}else{g=new ActiveXObject("Microsoft.XMLHTTP")}try{g.onreadystatechange=function(){if(g.readyState==4){if(g.status!=200){h.userConfiguration.ErrorHandler("backend-error")}else{if(f.callback!=null){var e=JSON.parse(g.responseText);if(e.Error==undefined&&e.Error==null){f.callback(e);if(a!=undefined){h.updateLoginDetails(e)}}else{h.userConfiguration.ErrorHandler("backend-error")}}}}}}catch(j){this.userConfiguration.ErrorHandler("backend-error")}try{g.open(f.requestType,f.sURL,true);g.setRequestHeader("Content-type","application/x-www-form-urlencoded");g.send(f.sParams)}catch(j){this.userConfiguration.ErrorHandler("backend-error")}}},err:function(){this.userConfiguration.ErrorHandler("backend-error")},timeo:function(){this.userConfiguration.ErrorHandler("backend-error")},progres:function(){},stopdata:function(){this.abort()},UpdateConfig:function(a){this.userConfiguration.ErrorHandler=a.ErrorHandler,this.userConfiguration.SocialNetwork=String(a.SocialNetwork).toLowerCase()}};TGE.PlayPhoneWrapper={dashboardButton:null,pendingAchievements:[],initialize:function(){if(typeof MNDirect==="undefined"){TGE.log("***** ERROR: PlayPhone SDK was not loaded properly.");return}MNDirect.AppReloadClient.setAppReloadHandler(MNDirect.AppReloadClient.APP_RELOAD_ALLOWED);MNDirect.AppReloadClient.setAppAfterReloadHandler(MNDirect.AppReloadClient.APP_AFTER_RELOAD_AUTO);MNDirectPopup.init(MNDirectPopup.MNDIRECTPOPUP_WELCOME);var a=78100;var b="08b10129-d2f5da4f-eb68767e-85df7a2d";MNDirect.init(a,b);MNDirectUIHelper.showDashboard();MNDirectUIHelper.addEventHandler(MNDirectUIHelper.EventName.onHideDashboard,TGE.PlayPhoneWrapper.onHideDashboard);MNDirect.addEventHandler(MNDirect.EventName.onUserLogin,TGE.PlayPhoneWrapper.onUserLogin);MNDirect.addEventHandler(MNDirect.EventName.onUserLogout,TGE.PlayPhoneWrapper.onUserLogout)},onHideDashboard:function(a){var b=MNDirect.getSession().isUserLoggedIn();if(!b){MNDirectUIHelper.showDashboard()}},onUserLogin:function(d){var f=MNDirect.getSession().isUserLoggedIn();if(f){TGE.PlayPhoneWrapper.hideDashboard();if(TGE.PlayPhoneWrapper.pendingAchievements.length>0){for(var b=0;b<TGE.PlayPhoneWrapper.pendingAchievements.length;b++){TGE.PlayPhoneWrapper.achievementEarned(TGE.PlayPhoneWrapper.pendingAchievements[b])}TGE.PlayPhoneWrapper.pendingAchievements=[]}}},onUserLogout:function(a){MNDirectUIHelper.showDashboard()},dashboardButtonClicked:function(a){MNDirect.execAppCommand("jumpToLeaderboard",null);MNDirectUIHelper.showDashboard()},hideDashboard:function(){MNDirectUIHelper.hideDashboard();if(TGE.Game&&TGE.Game.GetInstance()){TGE.Game.GetInstance()._determineCanvasPosition();if(TGE.PlayPhoneWrapper.dashboardButton===null){var h=TGE.Game.GetInstance().mCanvasDiv;TGE.PlayPhoneWrapper.dashboardButton=document.createElement("div");var b=80;var e=10;var d=TGE.PlayPhoneWrapper.dashboardButton;d.id="playphone_dashboard_button";d.style.position="absolute";var g=e*(TGE.BrowserDetect.isMobileDevice?3:1);var f=h.clientWidth-e-b;d.style.top=g.toString()+"px";d.style.left=f.toString()+"px";d.innerHTML="<img src='http://slb.tresensa.com/playphone/dashboard_button.png'>";d.style.cursor="pointer";d.style.zIndex=5;h.insertBefore(d,h.firstChild);var a=TGE.BrowserDetect.isMobileDevice?"touchstart":"click";d.addEventListener(a,TGE.PlayPhoneWrapper.dashboardButtonClicked,false)}}},showDashboardButton:function(){if(TGE.PlayPhoneWrapper.dashboardButton!==null){TGE.PlayPhoneWrapper.dashboardButton.style.display="block"}},hideDashboardButton:function(){if(TGE.PlayPhoneWrapper.dashboardButton!==null){TGE.PlayPhoneWrapper.dashboardButton.style.display="none"}},showAchievementsScreen:function(){if(typeof MNDirect==="undefined"){return}MNDirect.execAppCommand("jumpToAchievements",null);MNDirectUIHelper.showDashboard()},submitScore:function(a){if(typeof MNDirect==="undefined"){return}MNDirect.postGameScore(a)},achievementEarned:function(d){if(typeof MNDirect==="undefined"||typeof MNDirect.getSession()==="undefined"||!MNDirect.getSession().isUserLoggedIn()){TGE.PlayPhoneWrapper.pendingAchievements.push(d);return}var a=d+1;var b=function(e){if(e.hadError()){TGE.log("***** ERROR: PlayPhone SDK could not unlock achievement id "+a+", "+e.getErrorMessage())}};MNDirect.serviceProvider.Achievements.reqCurrUserUnlockAchievement(b,a)}};if(getDistributionPartner()==="A0014"){loadScript("http://webui.social.playphone.com/web_mnsapi/MNDirectHost.js.php",TGE.PlayPhoneWrapper.initialize)}TGE.PlatformCompatibility=function(){return this};TGE.PlatformCompatibility.prototype={isAudioSupported:function(){var b=document.createElement("audio"),a=false;try{if(a=!!b.canPlayType){a=new Boolean(a);a.ogg=b.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"");a.mp3=b.canPlayType("audio/mpeg;").replace(/^no$/,"");a.wav=b.canPlayType('audio/wav; codecs="1"').replace(/^no$/,"");a.m4a=(b.canPlayType("audio/x-m4a;")||b.canPlayType("audio/aac;")).replace(/^no$/,"")}}catch(d){}return a},isAudioFormatSupported:function(a){var f=document.createElement("audio"),b=false;var d;try{if(b=!!f.canPlayType){b=new Boolean(b);switch(a){case"ogg":d=f.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"");break;case"mp3":d=f.canPlayType("audio/mpeg;").replace(/^no$/,"");break;case"wav":d=f.canPlayType('audio/wav; codecs="1"').replace(/^no$/,"");break;case"m4a":d=(f.canPlayType("audio/x-m4a;")||f.canPlayType("audio/aac;")).replace(/^no$/,"");break;default:break}}}catch(g){}return d},isCanvasSupported:function(){var a=document.createElement("canvas");return !!(a.getContext&&a.getContext("2d"))},isVideoSupported:function(){var b=document.createElement("video"),a=false;try{if(a=!!b.canPlayType){a=new Boolean(a);a.ogg=b.canPlayType('video/ogg; codecs="theora"');a.h264=b.canPlayType('video/mp4; codecs="avc1.42E01E"');a.webm=b.canPlayType('video/webm; codecs="vp8, vorbis"')}}catch(d){}return a},isDragAndDropSupported:function(){var a=document.createElement("div");bool=("draggable" in a)||("ondragstart" in a&&"ondrop" in a);return bool},isGeolocationSupported:function(){return !!navigator.geolocation},isWebGlSupported:function(){try{var b=document.createElement("canvas"),a;a=!!(window.WebGLRenderingContext&&(b.getContext("experimental-webgl")||b.getContext("webgl")));b=undefined}catch(d){a=false}return a},isHistorySupported:function(){return !!(window.history&&history.pushState)},isVideoSupported:function(){var b=document.createElement("video"),a=false},isLocalStorageSupported:function(){try{localStorage.setItem(mod,mod);localStorage.removeItem(mod);return true}catch(a){return false}},isSessionStorageSupported:function(){try{sessionStorage.setItem(mod,mod);sessionStorage.removeItem(mod);return true}catch(a){return false}},isSVGSupported:function(){ns={svg:"http://www.w3.org/2000/svg"};return !!document.createElementNS&&!!document.createElementNS(ns.svg,"svg").createSVGRect}};TGE.DeviceOrientation=function(){return this};TGE.DeviceOrientation.prototype={orientationChangeCallBack:null,RegisterOrientationChange:function(a){TGE.DeviceOrientation.prototype.orientationChangeCallBack=a;window.addEventListener("orientationchange",TGE.DeviceOrientation.prototype.internalOrientationChanged);TGE.DeviceOrientation.prototype.internalOrientationChanged()},internalOrientationChanged:function(){if(window.orientation===90||window.orientation===-90){TGE.DeviceOrientation.prototype.orientationChangeCallBack("landscape")}else{TGE.DeviceOrientation.prototype.orientationChangeCallBack("portrait")}}};var Sha1={};Sha1.hash=function(h,z){z=(typeof z=="undefined")?true:z;if(z){h=Utf8.encode(h)}var n=[1518500249,1859775393,2400959708,3395469782];h+=String.fromCharCode(128);var x=h.length/4+2;var k=Math.ceil(x/16);var m=new Array(k);for(var A=0;A<k;A++){m[A]=new Array(16);for(var y=0;y<16;y++){m[A][y]=(h.charCodeAt(A*64+y*4)<<24)|(h.charCodeAt(A*64+y*4+1)<<16)|(h.charCodeAt(A*64+y*4+2)<<8)|(h.charCodeAt(A*64+y*4+3))}}m[k-1][14]=((h.length-1)*8)/Math.pow(2,32);m[k-1][14]=Math.floor(m[k-1][14]);m[k-1][15]=((h.length-1)*8)&4294967295;var u=1732584193;var r=4023233417;var q=2562383102;var p=271733878;var o=3285377520;var f=new Array(80);var F,E,D,C,B;for(var A=0;A<k;A++){for(var v=0;v<16;v++){f[v]=m[A][v]}for(var v=16;v<80;v++){f[v]=Sha1.ROTL(f[v-3]^f[v-8]^f[v-14]^f[v-16],1)}F=u;E=r;D=q;C=p;B=o;for(var v=0;v<80;v++){var w=Math.floor(v/20);var g=(Sha1.ROTL(F,5)+Sha1.f(w,E,D,C)+B+n[w]+f[v])&4294967295;B=C;C=D;D=Sha1.ROTL(E,30);E=F;F=g}u=(u+F)&4294967295;r=(r+E)&4294967295;q=(q+D)&4294967295;p=(p+C)&4294967295;o=(o+B)&4294967295}return Sha1.toHexStr(u)+Sha1.toHexStr(r)+Sha1.toHexStr(q)+Sha1.toHexStr(p)+Sha1.toHexStr(o)};Sha1.f=function(b,a,e,d){switch(b){case 0:return(a&e)^(~a&d);case 1:return a^e^d;case 2:return(a&e)^(a&d)^(e&d);case 3:return a^e^d}};Sha1.ROTL=function(a,b){return(a<<b)|(a>>>(32-b))};Sha1.toHexStr=function(e){var d="",a;for(var b=7;b>=0;b--){a=(e>>>(b*4))&15;d+=a.toString(16)}return d};var Utf8={};Utf8.encode=function(a){var b=a.replace(/[\u0080-\u07ff]/g,function(e){var d=e.charCodeAt(0);return String.fromCharCode(192|d>>6,128|d&63)});b=b.replace(/[\u0800-\uffff]/g,function(e){var d=e.charCodeAt(0);return String.fromCharCode(224|d>>12,128|d>>6&63,128|d&63)});return b};Utf8.decode=function(b){var a=b.replace(/[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/g,function(e){var d=((e.charCodeAt(0)&15)<<12)|((e.charCodeAt(1)&63)<<6)|(e.charCodeAt(2)&63);return String.fromCharCode(d)});a=a.replace(/[\u00c0-\u00df][\u0080-\u00bf]/g,function(e){var d=(e.charCodeAt(0)&31)<<6|e.charCodeAt(1)&63;return String.fromCharCode(d)});return a};