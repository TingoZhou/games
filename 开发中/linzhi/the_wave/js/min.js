function m(e,t){for(var n=k.createImageData(e.width*t,e.height*t),r=0;r<e.height;r++)for(var i=0;i<e.width;i++)for(var s=[e.data[4*(r*e.width+i)+0],e.data[4*(r*e.width+i)+1],e.data[4*(r*e.width+i)+2],e.data[4*(r*e.width+i)+3]],o=0;o<t;o++)for(var u=r*t+o,a=0;a<t;a++)for(var f=i*t+a,l=0;4>l;l++)n.data[4*(u*n.width+f)+l]=s[l];return n}function r(e,t,n,r,i,s,o){var u=Math.sqrt(Math.pow(r-s,2)+Math.pow(i-o,2));return 0===u?(e=Math.sqrt(Math.pow(e-r,2)+Math.pow(t-i,2)),e<n):(u=((e-r)*(s-r)+(t-i)*(o-i))/Math.pow(u,2),e=0>u?Math.sqrt(Math.pow(e-r,2)+Math.pow(t-i,2)):1<u?Math.sqrt(Math.pow(e-s,2)+Math.pow(t-o,2)):Math.sqrt(Math.pow(e-(r+u*(s-r)),2)+Math.pow(t-(i+u*(o-i)),2)),e<n)}function v(){for(var e=0;e<u.length;e++){k.beginPath(),k.moveTo(600+32*u[e][0],319+32*u[e][1]);for(var t=1;t<Math.floor(u[e].length/2);t++)k.lineTo(600+32*u[e][2*t],319+32*u[e][2*t+1]);k.closePath(),k.fillStyle=u[e][u[e].length-1]}}function w(e,t,n){var r=640/(n-1),i=Array(n);t-=e;for(var s=0;s<n;s++)i[s]={},i[s].x=s*r,i[s].y=e+t*Math.random();return i[0].y=180,i[i.length-1].y=180,i}function z(e,t){var n=B,r=640/(e-1),i=Array(e),s=n.a;n.a=t;for(var o=0;o<e;o++)i[o]={},i[o].x=o*r,i[o].y=n.t(i[o].x);return i[0].y=180,i[i.length-1].y=180,n.a=s,i}function C(){var e=D.w,t={width:640};return t.minHeight=Math.max(40,60-e),t.maxHeight=Math.min(320,300+e),t.g=Math.min(20,3+2*Math.floor(e/4)),t.i=10,t.z=1/(80-2*Math.floor(e/5)),t}function F(){var e=D.w,t={};return t.count=1+Math.floor(e/2.5),t.U=Math.max(20,140-5*Math.floor(e/4)),t.S=Math.min(620,500+5*Math.floor(e/4)),t.T=Math.max(8,10-Math.floor(e/10)),t.R=Math.min(10,15-Math.floor(e/5)),t}function M(t,n,i){this.x=t,this.y=n,this.size=i,this.a=0,this.F=e,this.A=0,this.color="white",this.update=function(){this.A+=.1,this.a=this.F?this.a-1/30:this.a+1/30;if(.25<this.a||-0.25>this.a)this.F=!this.F;this.color="white";var t;if(t=!I.p){var n=t=this.size,i=this.A,s=this.x+this.size/2,o=this.y+this.size/2,u=I.x,a=I.y,f=I.s,l;0===i?(l=u,u=a,a=s,i=o):(l=Math.cos(i)*u-Math.sin(i)*a,u=Math.cos(i)*a+Math.sin(i)*u,a=Math.cos(i)*s-Math.sin(i)*o,i=Math.cos(i)*o+Math.sin(i)*s),t=r(l,u,f,a-t/2,i+n/2,a+t/2,i+n/2)||r(l,u,f,a+t/2,i+n/2,a+t/2,i-n/2)||r(l,u,f,a+t/2,i-n/2,a-t/2,i-n/2)||r(l,u,f,a-t/2,i-n/2,a-t/2,i+n/2)?c:e}t&&J.remove(this)},this.f=function(){k.save(),k.beginPath(),k.translate(this.x+.5*this.size,this.y+.5*this.size),k.rotate(this.A*Math.PI/16),k.translate(-this.x-.5*this.size,-this.y-.5*this.size),k.moveTo(this.x,this.y),k.quadraticCurveTo(this.x-this.size*this.a,this.y+.5*this.size,this.x,this.y+this.size),k.quadraticCurveTo(this.x+.5*this.size,this.y+this.size+this.size*this.a,this.x+this.size,this.y+this.size),k.quadraticCurveTo(this.x+this.size+this.size*this.a,this.y+.5*this.size,this.x+this.size,this.y),k.quadraticCurveTo(this.x+.5*this.size,this.y-this.size*this.a,this.x,this.y),k.closePath(),k.lineWidth=2,k.strokeStyle=this.color,k.stroke(),k.restore()}}var c=!0,e=!1,h=document.getElementById("canvas"),k=h.getContext("2d"),u=[[.138671875,.8984375,.05859375,0,.939453125,0,.859375,.8984375,.498046875,1,"#E34F26"],[.5,.921875,.791015625,.841796875,.859375,.072265626,.5,.072265626,"#EF652A"],[.5,.40625,.353515625,.40625,.34375,.29296875,.5,.29296875,.5,.18359375,.498046875,.18359375,.22265625,.18359375,.224609375,.212890625,.251953125,.517578125,.5,.517578125,.5,.693359375,.498046875,.693359375,.375,.66015625,.3671875,.572265625,.30859375,.572265625,.2578125,.572265625,.271484375,.74609375,.498046875,.80859375,.5,.80859375,"#EBEBEB"],[.498046875,.40625,.498046875,.517578125,.634765625,.517578125,.62109375,.66015625,.498046875,.693359375,.498046875,.80859375,.724609375,.74609375,.7265625,.7265625,.751953125,.435546875,.755859375,.40625,.724609375,.40625,"#FFF"],[.498046875,.18359375,.498046875,.251953125,.498046875,.29296875,.498046875,.29296875,.765625,.29296875,.765625,.29296875,.765625,.29296875,.767578125,.26953125,.7734375,.212890625,.775390625,.18359375,"#FFF"]],D={c:function(e){if(!D.loaded){D.Z=60,D.a=0,D.P=new Date,D.w=0,D.loaded=c;var t=C(),n=F();H.c(e),B.c(t.width,t.minHeight,t.maxHeight,t.g,t.i,t.z),I.c(),J.c(n.count,n.U,H.y,n.S,H.y+H.height,n.T,n.R),K.c()}},load:function(e){D.w=e,e=C();var t=F();B.c(e.width,e.minHeight,e.maxHeight,e.g,e.i,e.z),J.c(t.count,t.U,H.y,t.S,H.y+H.height,t.T,t.R)},loop:function(){var e=new Date;D.a=(e-D.P)/1e3,D.P=e,H.update(),B.update(),J.update(),I.update(),K.update(),H.f(),B.f(),J.f(),I.f(),K.f()},D:function(){D.I||(D.H=window.setInterval(D.loop,1e3/D.Z),D.I=c)},pause:function(){D.I&&(window.clearInterval(D.H),D.I=e)},stop:function(){D.pause(),D.load(0)},next:function(){D.pause(),D.load(D.w+1),D.D()}},B={c:function(t,n,r,i,s,o){B.minHeight=n,B.maxHeight=r,B.i=s,B.width=t,B.z=o,B.N=e,!B.b||!B.h?(B.a=0,B.b=w(n,r,i),B.h=w(n,r,i)):B.g!==i&&(B.b=z(i,0),B.h=z(i,1)),B.g=i},t:function(e){var t=Math.floor(e/(B.width/(B.g-1)));if(t+1>=B.b.length||t+1>=B.h.length)return 180;var n=B.b[t].y+(B.h[t].y-B.b[t].y)*B.a,r=B.b[t+1].y+(B.h[t+1].y-B.b[t+1].y)*B.a;return.5*(n+r)+Math.cos(Math.PI/B.i*((e-t*(B.width/(B.g-1)))/(B.width/(B.g-1)/B.i)))*.5*(n-r)},da:function(e){e=Math.floor(e/(B.width/(B.g-1)))*(B.width/(B.g-1))+e%(Math.PI/B.i);var t=e+Math.PI/B.i,n=B.t(t)-B.t(e),n=n/Math.sqrt(Math.pow(t-e,2)+Math.pow(n,2));return Math.asin(n)},atan:function(e){if(0>=e&&640<=e)return 1;var t=B.t(e-1);return e=B.t(e+1),t===e?1:Math.atan(2/Math.abs(t-e))},update:function(){B.a+=60*B.z*D.a,1<=B.a&&(B.a=0,B.b=B.h,I.p?B.N?I.x===H.x+20&&(D.load(0),I.reset()):(B.N=c,B.h=w(180,180,B.g)):B.h=w(B.minHeight,B.maxHeight,B.g))},f:function(){k.save(),k.beginPath(),k.moveTo(0,B.b[0].y);for(var e=0;e<B.b.length-1;e++)for(var t=B.b[e].y+(B.h[e].y-B.b[e].y)*B.a,n=B.b[e+1].y+(B.h[e+1].y-B.b[e+1].y)*B.a,r=.5*(t+n),t=.5*(t-n),n=Math.PI/B.i,i=0;i<B.i;i++)k.lineTo(B.b[e].x+(B.b[e+1].x-B.b[e].x)*1/B.i*i,r+Math.cos(n*i)*t);k.lineTo(B.width,B.b[B.b.length-1].y),k.lineWidth=2,k.strokeStyle="white",k.stroke(),k.restore()}},I={c:function(){I.q||(I.q=c,I.x=H.x+20,I.y=0,I.s=10,I.m=100,I.color="white",I.p=e,I.a=1,I.J=0,I.r=0)},reset:function(){I.m=100,I.p=e,I.a=1,I.J=0},update:function(){I.y=B.t(I.x);var e=I.x,t=I.y,n=I.s,r=H.height,i=H.x,s=H.y;e-n>i+H.width||e+n<i||t-n>s+r||t+n<s?(0<I.m?I.m-=1:(I.p=c,I.J=I.x),I.color="red"):(!I.p&&100>I.m&&(I.m+=.01),I.color="white"),I.p?I.x!==H.x+20&&(I.a=Math.max(0,I.a-B.z),I.x=I.J*I.a+(H.x+20)*(1-I.a),I.m=100*(1-I.a)):(L.O(L.X)||Touch.u&&320>Touch.d.x&&323>Touch.d.y?(I.x-=6*Math.abs(B.atan(I.x))*60*D.a*I.r,I.r=Math.min(1,I.r+.1)):L.O(L.Y)||Touch.u&&320<Touch.d.x&&323>Touch.d.y?(I.x+=6*Math.abs(B.atan(I.x))*60*D.a*I.r,I.r=Math.min(1,I.r+.1)):I.r=0,0>I.x-I.s?I.x=I.s:640<I.x+I.s&&(I.x=640-I.s))},f:function(){k.save(),k.beginPath(),k.arc(I.x,I.y,I.s,0,2*Math.PI,e),k.lineWidth=2,k.fillStyle=I.color,k.fill(),k.strokeStyle=I.color,k.stroke(),k.restore()}},H={c:function(e){H.x=30,H.y=120,H.width=580,H.height=120,H.color||(H.color=e),H.a||(H.a=0)},update:function(){H.a+=2*D.a,2<=H.a&&(H.a=0)},f:function(){k.save(),k.fillStyle=H.color,k.fillRect(0,0,640,360);for(var e=H.x,t=H.x+H.width,e=e+6*(-1+H.a),t=t-6*(-1+H.a);e<H.x+H.width;){var n=Math.min(H.x+H.width,Math.max(H.x,e));k.beginPath(),k.moveTo(n,H.y),e+=6,n=Math.min(H.x+H.width,Math.max(H.x,e)),k.lineTo(n,H.y),e+=6,n=Math.min(H.x+H.width,Math.max(H.x,t)),k.moveTo(n,H.y+H.height),t-=6,n=Math.min(H.x+H.width,Math.max(H.x,t)),k.lineTo(n,H.y+H.height),k.lineWidth=2,k.strokeStyle="white",k.stroke(),t-=6}e=H.y,t=H.y+H.height,e+=6*(-1+H.a);for(t-=6*(-1+H.a);e<H.y+H.width;)n=Math.min(H.y+H.height,Math.max(H.y,e)),k.beginPath(),k.moveTo(H.x+H.width,n),e+=6,n=Math.min(H.y+H.height,Math.max(H.y,e)),k.lineTo(H.x+H.width,n),e+=6,n=Math.min(H.y+H.height,Math.max(H.y,t)),k.moveTo(H.x,n),t-=6,n=Math.min(H.y+H.height,Math.max(H.y,t)),k.lineTo(H.x,n),k.lineWidth=2,k.strokeStyle="white",k.stroke(),t-=6;k.restore()}},J={c:function(e,t,n,r,i,s,o){var u=[];u.length=e;for(var a=0;a<e;a++)u[a]=new M(t+(r-t)*Math.random(),n+(i-n)*Math.random(),s+(o-s)*Math.random());J.j=u},update:function(){if(!I.p)for(var e=0;e<J.j.length;e++)J.j[e].update()},f:function(){if(!I.p)for(var e=0;e<J.j.length;e++)J.j[e].f()},remove:function(e){for(var t=0;t<J.j.length&&J.j[t]!==e;){if(t===J.j.length-1)return;t++}J.j.splice(t,1),0===J.j.length&&D.next()}},L={c:function(){L.q||(L.q=c,L.L=[],L.v=0,L.X=37,L.ca=38,L.Y=39,L.ba=40,L.O=function(e){return L.L[e]},L.ea=function(){return 0<L.v},L.$=function(e){L.L[e.keyCode]=c,L.v++},L.aa=function(e){delete L.L[e.keyCode],L.v--,0>L.v&&(L.v=0)},window.addEventListener("keyup",function(e){L.aa(e)},e),window.addEventListener("keydown",function(e){L.$(e)},e))}},Touch={c:function(){Touch.q||(Touch.q=c,Touch.d={},Touch.d.x=0,Touch.d.y=0,Touch.u=e,Touch.W=function(e){e||(e=event),"ontouchstart"in window?(e.preventDefault(),Touch.d.x=e.targetTouches[0].pageX-h.offsetLeft,Touch.d.y=e.targetTouches[0].pageY-h.offsetTop):(Touch.d.x=e.clientX-h.offsetLeft,Touch.d.y=e.clientY-h.offsetTop),Touch.u=c},Touch.V=function(t){Touch.u=e,"ontouchstart"in window?(t.preventDefault(),Touch.d.x=t.targetTouches[0].pageX-h.offsetLeft,Touch.d.y=t.targetTouches[0].pageY-h.offsetTop):(Touch.d.x=t.clientX-h.offsetLeft,Touch.d.y=t.clientY-h.offsetTop),D.loaded&&304<=Touch.d.x&&336>=Touch.d.x&&323<=Touch.d.y&&360>=Touch.d.y&&D.C&&(N.paused?N.play():N.pause())},h.addEventListener("touchstart",function(e){Touch.W(e)},e),h.addEventListener("touchend",function(e){Touch.V(e)},e),h.addEventListener("mousedown",function(e){Touch.W(e)},e),h.addEventListener("mouseup",function(e){Touch.V(e)},e))}},K={c:function(){K.q||(K.q=c,K.Q=[0,4,6,7,8,9,10,13,14,15,18,24,25,26,27,28,30,34,35,39,41,47,51,53,61,65,69,70,71,72,73,74,76,77,78,79,82,86,88,96,100,101,102,103,104,105,109,111,117,118,119,120,121,123,131,135,139,140,144,146,147,148,149,150,152,156,158,159,160,161,162,166,170,174],K.fa=[[0,1,2,3,4,7,8,11,12,15,16,17,18,19],[2,5,6,10,14,17,18,19],[0,1,2,3,7,8,9,10,11,12,16,17,18,19],[0,1,2,3,7,8,9,10,11,15,16,17,18,19],[0,3,4,7,8,9,10,11,15,19],[0,1,2,3,4,8,9,10,11,15,16,17,18,19],[9,1,2,3,4,8,9,10,11,12,15,16,17,18,19],[0,1,2,3,7,11,15,19],[0,1,2,3,4,7,8,9,10,11,12,15,16,17,18,19],[9,1,2,3,4,7,8,9,10,11,15,16,17,18,19]],K.B=[[5,6,9,10,13,14],[0,1,3,4,7,8,9,11,12,13,15,16],[4,5,6,13,14,15],[4,5,6,12,13,14],[1,2,5,6,12,13,14,16,17,18],[5,6,7,12,13,14],[5,6,7,13,14],[4,5,6,8,9,10,12,13,14,16,17,18],[5,6,13,14],[5,6,12,13,14]],K.G=[39,40,54,55,56,69,70,71,72,84,85,86,87,88,91,97,98,99,100,101,102,103,104,106,110,113,114,115,116,117,118,119,120,122,125,129,130,131,132,133,134,135,136,138,141,145,146,147,148,149,150,151,152,154,158,164,165,166,167,168,171,181,182,183,184,198,199,200,215,216])},update:function(){},f:function(){k.save(),k.fillStyle="white",k.fillRect(0,5,6.4*I.m,16);for(var e=k.getImageData(5,7,35,5),n=0;n<K.Q.length;n++){var r=4*K.Q[n];if(255===(e.data[r]|e.data[r+1]|e.data[r+2])||0===(e.data[r]|e.data[r+1]|e.data[r+2]))e.data[r]=255-e.data[r],e.data[r+1]=255-e.data[r+1],e.data[r+2]=255-e.data[r+2];else{var s;s=e.data[r];var o=e.data[r+1],u=e.data[r+2];hsv={},max=Math.max(Math.max(s,o),u),dif=max-Math.min(Math.min(s,o),u),hsv.o=0===max?0:100*dif/max,0===hsv.o?hsv.e=0:s===max?hsv.e=60*(o-u)/dif:o===max?hsv.e=120+60*(u-s)/dif:u===max&&(hsv.e=240+60*(s-o)/dif),0>hsv.e&&(hsv.e+=360),hsv.value=Math.round(100*max/255),hsv.e=Math.round(hsv.e),hsv.o=Math.round(hsv.o),hsv.e=(hsv.e-180)%360,s={};if(0===hsv.o)s.n=s.l=s.k=Math.round(2.55*hsv.value);else{hsv.e/=60,hsv.o/=100,hsv.value/=100,i=Math.floor(hsv.e),f=hsv.e-i,p=hsv.value*(1-hsv.o),q=hsv.value*(1-hsv.o*f),t=hsv.value*(1-hsv.o*(1-f));switch(i){case 0:s.n=hsv.value,s.l=t,s.k=p;break;case 1:s.n=q,s.l=hsv.value,s.k=p;break;case 2:s.n=p,s.l=hsv.value,s.k=t;break;case 3:s.n=p,s.l=q,s.k=hsv.value;break;case 4:s.n=t,s.l=p,s.k=hsv.value;break;default:s.n=hsv.value,s.l=p,s.k=q}s.n=Math.round(255*s.n),s.l=Math.round(255*s.l),s.k=Math.round(255*s.k)}e.data[r]=s.n,e.data[r+1]=s.l,e.data[r+2]=s.k}}k.textBaseline="top",k.fillStyle="#000",k.font="12px 宋体",k.fillText("生命值",5,7),e=k.getImageData(12,324,4,5),s=k.getImageData(12,324,4,5),k.beginPath(),k.fillStyle="white",k.fillRect(8,319,54,33),o=D.w;for(n=0;n<K.B[Math.floor(o/10)].length;n++)r=4*K.B[Math.floor(o/10)][n],e.data[r]=e.data[r+1]=e.data[r+2]=255;for(n=0;n<K.B[o%10].length;n++)r=4*K.B[o%10][n],s.data[r]=s.data[r+1]=s.data[r+2]=255;e=m(e,5),s=m(s,5),k.putImageData(e,12,323),k.putImageData(s,37,323),k.fillStyle="#fff",r=k.getImageData(304,323,16,16);for(n=0;n<K.G.length;n++)N.paused&&8<K.G[n]%16||(r.data[4*K.G[n]+3]=0);v(),k.restore()}},O={c:function(){O.M=[80,60,60,60,60,80,80,80,80,80,80,80,80,80,80,80,80,80,80,60,100,80,100,60,100,100,100,60,100,100,100,60,100,60,80,80,80,80,80,80];var t=Math.floor(5.99*Math.random());O.color="#ed5067",O.color=1===t?"#6ce3ef":2===t?"#a2b7b9":3===t?"#f3ea9b":4===t?"#de6ef2":"#000000",O.K=e},loop:function(){O.update(),null!==O&&O.f()},update:function(){Touch.u&&O.K&&(window.clearInterval(O.H),D.c(O.color),D.D(),D.C&&N.play(),O=null)},f:function(){if(O.K){k.save(),k.fillStyle=O.color,k.fillRect(0,0,640,360),k.beginPath(),k.moveTo(0,40);for(var e=115,t=0;t<O.M.length-1;t++)for(var e=e+10,n=O.M[t],r=O.M[t+1],i=.5*(n+r),n=.5*(n-r),r=Math.PI/10,s=0;10>s;s++)k.lineTo(e+s,-40+i+Math.cos(r*s)*n);k.lineTo(640,40),k.moveTo(150,20),k.lineTo(150,60),k.moveTo(195,20),k.lineTo(195,60),k.moveTo(225,20),k.lineTo(225,60),k.moveTo(275,20),k.lineTo(245,20),k.lineTo(245,60),k.lineTo(275,60),k.moveTo(515,20),k.lineTo(485,20),k.lineTo(485,60),k.lineTo(515,60),k.lineWidth=2,k.strokeStyle="white",k.stroke(),k.font='16px "Courier New"',k.fillStyle="#FFF",k.textAlign="center",k.fillText("触摸屏幕左右部分控制小球的位置，",320,170),k.fillText("捡一颗星星得一分，",320,190),k.fillText("超出虚线方框区域生命值会减少，生命值为零游戏重新开始",320,210),k.font='24px "Courier New"',k.fillStyle="#FFF",k.textAlign="center",k.fillText("点击开始",320,300),k.font='10px "Courier New"',k.textAlign="left",k.fillText("COPYRIGHT © 2004 - 2013 UCWeb Inc. All Rights Reserved.",16,344),v(),k.restore()}else k.fillStyle=O.color,k.fillRect(0,0,640,360),k.font='16px "Courier New"',k.fillStyle="#FFF",k.textAlign="center",k.fillText("Loading...",320,180)},D:function(){O.H=window.setInterval(O.loop,1e3/60)}},N;window.onload=function(){L.c(),Touch.c(),O.c(),O.D(),D.C=e,O.K=c,N=new Audio,N.ga=e,N.autoplay=e,N.addEventListener("canplaythrough",function(){D.C=c,N.removeEventListener("canplaythrough")},e),"boolean"==typeof N.loop?N.loop=c:N.addEventListener("ended",function(){D.C&&(N.currentTime=0,N.play())},e),document.body.addEventListener("touchstart",function(e){e.preventDefault()},!1),window.addEventListener("orientationchange",function(e){})};function getElementPosition(e){var t=e,n="",r=0,i=0;if(t==null)return null;while(typeof t=="object"&&typeof t.tagName!="undefined"){i+=t.offsetTop,r+=t.offsetLeft,n=t.tagName.toUpperCase(),n=="BODY"&&(t=0),typeof t=="object"&&typeof t.offsetParent=="object"&&(t=t.offsetParent);if(t==null)return null}return{x:r,y:i}}Function.prototype.bind||(Function.prototype.bind=function(e){if(typeof this!="function")throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),n=this,r=function(){},i=function(){return n.apply(this instanceof r&&e?this:e,t.concat(Array.prototype.slice.call(arguments)))};return r.prototype=this.prototype,i.prototype=new r,i});var TGE={};TGE.log=function(){window.console&&window.console.log(Array.prototype.slice.call(arguments))},TGE.debugLog=function(){},TGE.Game=function(e){if(TGE.Game._sInstance!==null)return TGE.log("***** ERROR: you can only create one instance of a TGE.Game object"),this;TGE.Game._sInstance=this,this.analytics=null,this.mCanvasDiv=null,this.mReorientationDiv=null,this.mCanvasPosition=null,this.mLayers={},this.mCameraLocation=null,this.mLoadingStartTime=(new Date).getTime(),this.mLoadingScreen=null,this.stage=null,this.mPlaying=!1,this.mPaused=!1,this.mCurrentLevel=null,this.mPauseButton=null,this.mUserPauseEnabled=!1,this.mGameTime=0,this.mFilterStrength=10,this.mFrameTime=0,this.mLastLoop=new Date,this.mLastDisplay=new Date,this.mThisLoop,this.mFPSText=null,this.mMaxTickTime=.1,this.mMinTickTime=Number.MIN_VALUE,this.mMouseX=0,this.mMouseY=0,this.mMouseDown=!1,this.mKeysDown={},this.mDefaultLinkTarget="_blank",this.canvasWidth=0,this.canvasHeight=0,this._mNativeScaling=null,this._mViewportScale=1,this._oniOS=TGE.BrowserDetect.platform==="iPhone"||TGE.BrowserDetect.platform==="iPad",this._onAndroid=TGE.BrowserDetect.platform==="Android"},TGE.Game._sInstance=null,TGE.Game.prototype={_mViewportScale:0,_mResizeTimeout:null,_oniOS:!1,_onAndroid:!1,onMobile:function(){return TGE.BrowserDetect.isMobileDevice},oniOS:function(){return this._oniOS},onAndroid:function(){return this._onAndroid},onPhoneGap:function(){return TGE.BrowserDetect.usingPhoneGap},InitializeRenderer:function(e,t){this.stage=new TGE.Stage(this.mCanvasDiv,e,t)},Launch:function(e,t){var n,r,i=-1,s=-1,o=-1,u=-1,a=!1;this.analytics===null&&this.mAnalytics!=null&&(this.analytics=this.mAnalytics),typeof e=="string"?(n=e,r=t):(n=typeof e.gameDiv=="undefined"?null:e.gameDiv,r=typeof e.reorientDiv=="undefined"?null:e.reorientDiv,i=typeof e.width=="undefined"?-1:e.width,s=typeof e.height=="undefined"?-1:e.height,o=typeof e.initialWidth=="undefined"?-1:parseInt(e.initialWidth),u=typeof e.initialHeight=="undefined"?-1:parseInt(e.initialHeight),a=typeof e.resizeForNative=="undefined"?!1:e.resizeForNative),this.mCanvasDiv=document.getElementById(n);if(this.mCanvasDiv==null)return TGE.log("***** ERROR: Could not find canvas div '"+n+"'"),!1;var f=this.mCanvasDiv.getAttribute("style")||"";this.mCanvasDiv.setAttribute("style",f+" z-index: 1; overflow: hidden; -webkit-user-select: none; -ms-touch-action:none; -webkit-tap-highlight-color: transparent; -moz-tap-highlight-color: transparent; -webkit-transform: translateZ(0);");if(a){var l=document.getElementById("viewporter");l!==null&&(l.align="left");var c=1;TGE.BrowserDetect.platform==="iPad"?(c=.75,i=this.mCanvasDiv.clientWidth,s=Math.round(c*i)):TGE.BrowserDetect.platform==="iPhone"&&(c=320/480,i=this.mCanvasDiv.clientWidth,s=Math.round(c*i),l!==null&&(window.innerWidth>480||window.innerHeight>480)&&(l.align="center")),c!==1&&(this._mNativeScaling={x:i/this.mCanvasDiv.clientWidth,y:s/this.mCanvasDiv.clientHeight})}return i>0&&s>0&&(this.mCanvasDiv.style.width=i+"px",this.mCanvasDiv.style.height=s+"px"),this.canvasWidth=this.mCanvasDiv.clientWidth,this.canvasHeight=this.mCanvasDiv.clientHeight,TGE.debugLog("game launch calling _resizeViewport"),this.mReorientationDiv=document.getElementById(r),this._resizeViewport(),this._determineCanvasPosition(),window.addEventListener("resize",this._onResize.bind(this),!1),this.onMobile()&&(window.addEventListener("blur",this._onDeactivate.bind(this),!1),window.addEventListener("pagehide",this._onDeactivate.bind(this),!1),this.onPhoneGap()&&document.addEventListener("pause",this._onDeactivate.bind(this),!1)),"ontouchstart"in document.documentElement&&TGE.BrowserDetect.isMobileDevice?(this.mCanvasDiv.addEventListener("touchstart",this._mouseDown.bind(this),!1),this.mCanvasDiv.addEventListener("touchmove",this._mouseMove.bind(this),!1),this.mCanvasDiv.addEventListener("touchend",this._mouseUp.bind(this),!1)):(this.mCanvasDiv.addEventListener("click",this._preventBehavior.bind(this),!1),this.mCanvasDiv.addEventListener("mousedown",this._mouseDown.bind(this),!1),this.mCanvasDiv.addEventListener("mouseup",this._mouseUp.bind(this),!1),this.mCanvasDiv.addEventListener("mousemove",this._mouseMove.bind(this),!1)),window.addEventListener("orientationchange",this._onOrientationChanged),window.addEventListener("touchstart",function(e){e.preventDefault()},!1),typeof viewporter!="undefined"&&typeof viewporter.preventPageScroll=="function"&&(viewporter.preventPageScroll=!0),!0},_onDeactivate:function(){this.mPlaying&&(this.PauseGame(!0),this.audioManager.Mute())},_preventBehavior:function(e){e.stopPropagation(),e.preventDefault()},_processMousePosition:function(e){this.mCanvasPosition===null&&this._determineCanvasPosition(),this.mMouseX=e.pageX,this.mMouseY=e.pageY,e.touches&&(this.mMouseX=e.touches[0].clientX+document.body.scrollLeft+document.documentElement.scrollLeft,this.mMouseY=e.touches[0].clientY+document.body.scrollTop+document.documentElement.scrollTop),this.mMouseX-=this.mCanvasPosition.x,this.mMouseY-=this.mCanvasPosition.y,this.mMouseX/=this._mViewportScale,this.mMouseY/=this._mViewportScale},_mouseDown:function(e){window.focus(),this._processMousePosition(e),this.mMouseDown=!0;if(this.mUserPauseEnabled&&this.mPauseButton!=null&&this.mGameTime>.5){var t=Math.max(this.mPauseButton.Width(),this.mPauseButton.Height());if(this.mMouseX>this.Width()-t&&this.mMouseY<t){this.PauseGame(!0);return}}this.mPaused||this.subclassMouseDown(),e.stopPropagation(),e.preventDefault()},_mouseUp:function(e){this.mMouseDown=!1,this.mPaused||this.subclassMouseUp(),e.stopPropagation(),e.preventDefault()},_mouseMove:function(e){this._processMousePosition(e),this.mPaused||this.subclassMouseMove(),e.stopPropagation(),e.preventDefault()},subclassMouseMove:function(){},subclassMouseDown:function(){},subclassMouseUp:function(){},_centerCanvasDiv:function(e,t,n,r){this.mCanvasDiv.style.position="absolute";if(e){this.mCanvasDiv.style.align="left",this.mCanvasDiv.style.left=this._getBrowserWidth()/2-n/2+"px";var i=document.getElementById("viewporter");i&&(i.style.align="left")}t&&(this.mCanvasDiv.style.top=this._getBrowserHeight()/2-r/2+"px")},_getBrowserWidth:function(){return window.innerWidth?window.innerWidth:document.documentElement&&document.documentElement.clientWidth!=0?document.documentElement.clientWidth:document.body?document.body.clientWidth:0},_getBrowserHeight:function(){return window.innerHeight?window.innerHeight:document.documentElement&&document.documentElement.clientHeight!=0?document.documentElement.clientHeight:document.body?document.body.clientHeight:0},_resizeViewport:function(){TGE.debugLog("_resizeViewport");if(typeof window.canvasScale!="undefined"){TGE.debugLog("_resizeViewport for JSEmbed using stage scaling"),this.scaleStage(window.canvasScale);return}var e=this.mCanvasDiv,t=e.getAttribute("style")||"",n=this.canvasWidth,r=this.canvasHeight,i=window.innerWidth,s=window.innerHeight;TGE.debugLog("_resizeViewport::game size: "+n+"x"+r+", \nscreen size: "+i+"x"+s);var o=n<=r,u=i<=s,a=u===o,f={x:1,y:1};f.x=i/n,f.y=s/r,f.x=Math.round(f.x*100)/100,f.y=Math.round(f.y*100)/100;var l=1,c;f.x<f.y?(l=f.x,c=!0):(l=f.y,c=!1),Math.abs(1-l)<=.01&&(l=1);var h=n*l,p=r*l;if(TGE.BrowserDetect.usingPhoneGap){TGE.debugLog("_resizeViewport for native using stage scaling"),this._scaleCanvasDiv(l),this._centerCanvasDiv(!0,!0,h,p);return}TGE.BrowserDetect.isMobileDevice?(TGE.BrowserDetect.platform==="Android"&&parseInt(TGE.BrowserDetect.OSversion.charAt(0))<4||TGE.BrowserDetect.oniOS&&TGE.BrowserDetect.OSversion.charAt(0)<6||TGE.BrowserDetect.platform==="Kindle Fire"?(TGE.debugLog("_resizeViewport for mobile web using stage scaling"),this._scaleCanvasDiv(l)):(TGE.debugLog("_resizeViewport for mobile web using css transform scaling"),this._mViewportScale=l,f=l+", "+l,e.setAttribute("style",t+" -ms-transform-origin: left top; -webkit-transform-origin: left top; -moz-transform-origin: left top; -o-transform-origin: left top; transform-origin: left top; -ms-transform: scale("+f+"); -webkit-transform: scale3d("+f+", 1); -moz-transform: scale("+f+"); -o-transform: scale("+f+"); transform: scale("+f+");")),this._centerCanvasDiv(!0,!0,h,p)):this._centerCanvasDiv(!0,!1,n,r),this.mReorientationDiv!==null&&TGE.BrowserDetect.isMobileDevice&&this.oniOS()&&(a?(this.mReorientationDiv.style.display="none",this.mCanvasDiv.style.display="block"):(this.mCanvasDiv.style.display="none",this.mReorientationDiv.style.display="block")),this._determineCanvasPosition(),typeof viewporter!="undefined"&&typeof viewporter.refresh=="function"},_determineCanvasPosition:function(){TGE.debugLog("_determineCanvasPosition"),this.mCanvasPosition=getElementPosition(this.mCanvasDiv)},_onResize:function(){TGE.debugLog("_onResize::_mResizeTimeout: "+this._mResizeTimeout),this._mResizeTimeout!==null&&(clearTimeout(this._mResizeTimeout),this._mResizeTimeout=null),this.onAndroid()?this._mResizeTimeout=setTimeout(this._resizeViewport.bind(this),500):this._resizeViewport()}},TGE.ObjectsManager=function(){this.mObjectsArray=[]},TGE.BrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"an unknown browser",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version",this.platform=this.searchString(this.dataPlatform)||"an unknown OS or Device",this.OSversion=this.detectOSversion(this.platform),this.isMobileDevice=this.platform!=="Windows"&&this.platform!=="Mac"&&this.platform!=="Linux",this.oniOS=this.platform==="iPhone"||this.platform==="iPad",this.onAndroid=this.platform==="Android",this.usingPhoneGap=window.PhoneGap||window.cordova||window.Cordova},detectOSversion:function(e){var t="-1",n="",r=navigator.userAgent.toString();switch(e){case"Windows Phone":n=/Windows Phone OS\s+[\d\.]+/,t=String(r.match(n)).substring(17,20);break;case"iPhone":case"iPad":n=/OS\s+[\d\_]+/,t=String(r.match(n)).substring(3,6);break;case"Windows":n=/Windows NT\s+[\d\.]+/;var i=String(r.match(n)).substring(11,14);i=="6.1"?t="7":i=="5.1"?t="XP":i=="5.2"?t="XP":i=="6.0"?t="Vista":i=="5.01"?t="2000 SP1":i=="5.0"&&(t="2000");break;case"Mac":n=/Mac OS X\s+[\d\_]+/,t=String(r.match(n)).substring(9,13);break;case"Android":n=/ndroid\s+[\d\.]+/,t=String(r.match(n)).substring(7,10)}return t},searchString:function(e){for(var t=0;t<e.length;t++)if(e[t]!=null){var n=e[t].string,r=e[t].prop;this.versionSearchString=e[t].versionSearch||e[t].identity;if(n){if(n.indexOf(e[t].subString)!==-1)return e[t].identity}else if(r)return e[t].identity}},searchVersion:function(e){var t=e.indexOf(this.versionSearchString);if(t===-1)return;return parseFloat(e.substring(t+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Explorer",identity:"Explorer",versionSearch:"Explorer"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{prop:window.opera,identity:"Opera"},{string:navigator.userAgent,subString:"Silk",identity:"Silk",versionSearch:"Silk"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.vendor,subString:"BlackBerry",identity:"BlackBerry"}],dataPlatform:[{string:navigator.userAgent,subString:"Windows Phone",identity:"Windows Phone"},{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone"},{string:navigator.userAgent,subString:"iPad",identity:"iPad"},{string:navigator.userAgent,subString:"iPod",identity:"iPod"},{string:navigator.userAgent,subString:"Android",identity:"Android"},{string:navigator.userAgent,subString:"Silk",identity:"Kindle Fire"},{string:navigator.userAgent,subString:"webOS",identity:"webOS"},{string:navigator.userAgent,subString:"Mobile",identity:"Mobile"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]},TGE.BrowserDetect.init();if(TGE.BrowserDetect.platform==="iPhone"||TGE.BrowserDetect.platform==="iPad"){var _vp=document.querySelector("meta[name=viewport]");_vp&&_vp.setAttribute("content","maximum-scale=1, minimum-scale=1, initial-scale=1, user-scalable=no")};